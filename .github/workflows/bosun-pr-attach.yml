name: "Bosun: Attach PR Marker"

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  attach:
    name: Attach Bosun marker
    runs-on: ubuntu-latest
    steps:
      - name: Ensure `bosun-attached` label exists (best effort)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const name = "bosun-attached";
            try {
              await github.rest.issues.getLabel({ owner, repo, name });
            } catch (err) {
              if (err?.status === 404) {
                try {
                  await github.rest.issues.createLabel({
                    owner,
                    repo,
                    name,
                    color: "7c3aed",
                    description: "Bosun PR attachment marker",
                  });
                } catch (createErr) {
                  core.warning(
                    "Unable to create label '" +
                      name +
                      "': " +
                      String(createErr?.message || createErr),
                  );
                }
              } else {
                core.warning(
                  "Unable to verify label '" +
                    name +
                    "': " +
                    String(err?.message || err),
                );
              }
            }

      - name: Apply idempotent marker comment and optional label
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const label = "bosun-attached";
            const marker = "<!-- bosun-attached -->";
            const trigger =
              String(context.eventName || "unknown") +
              " / " +
              String((context.payload && context.payload.action) || "unknown");
            const body = [
              marker,
              "Bosun attached.",
              "",
              "This PR is tracked by Bosun attachment automation.",
              "- Marker label: bosun-attached",
              "- CI failure signal label: bosun-needs-fix",
              "- CI failure marker: <!-- bosun-ci-failure -->",
              "- Trigger: " + trigger,
            ].join("\n");

            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: [label],
              });
            } catch (err) {
              core.warning(
                "Unable to apply label '" +
                  label +
                  "': " +
                  String(err?.message || err),
              );
            }

            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number, per_page: 100 },
            );
            const existing = comments.find((c) =>
              typeof c.body === "string" && c.body.includes(marker),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
