# Publish bosun to npm via OIDC Trusted Publishing
#
# Triggers:
#   1. Push to main that changes package.json or source files
#   2. Manual dispatch with optional version bump / force flag
#
# Prerequisites (one-time setup):
#   Configure Trusted Publisher on npmjs.com:
#     Package → Settings → Publishing Access → Add Trusted Publisher
#       - Organization: virtengine
#       - Repository: bosun
#       - Workflow filename: publish.yaml
#       - Environment: npm-publish
#   Configure GitHub environment:
#     Repo → Settings → Environments → Create "npm-publish"

name: "Publish to npm"

env:
    NODE_VERSION: "24"

on:
    push:
        branches: [main]
        paths:
            - "**/*.mjs"
            - "package.json"
            - "package-lock.json"
            - "!.env*"
            - "!logs/**"
            - "!*.config.json"
            - "!workspaces.json"
    workflow_dispatch:
        inputs:
            dry-run:
                description: "Dry run (skip actual publish)"
                type: boolean
                default: false
            force:
                description: "Force publish even if version unchanged"
                type: boolean
                default: false

concurrency:
    group: bosun-publish
    cancel-in-progress: false

permissions:
    contents: read
    id-token: write

jobs:
    check:
        name: Version Check
        runs-on: ubuntu-latest
        outputs:
            should-publish: ${{ steps.compare.outputs.should-publish }}
            local-version: ${{ steps.compare.outputs.local-version }}
            registry-version: ${{ steps.compare.outputs.registry-version }}
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  registry-url: "https://registry.npmjs.org"
                  cache: "npm"
                  cache-dependency-path: package-lock.json

            - name: Compare versions
              id: compare
              run: |
                  LOCAL=$(node -p "require('./package.json').version")
                  echo "local-version=$LOCAL" >> "$GITHUB_OUTPUT"

                  REGISTRY=$(npm view bosun version 2>/dev/null || echo "0.0.0")
                  echo "registry-version=$REGISTRY" >> "$GITHUB_OUTPUT"

                  DOMINATED=$(node -e "
                    const [a, b] = ['$LOCAL', '$REGISTRY'].map(v => v.split('.').map(Number));
                    const newer = a[0] > b[0] || (a[0] === b[0] && a[1] > b[1]) || (a[0] === b[0] && a[1] === b[1] && a[2] > b[2]);
                    console.log(newer ? 'true' : 'false');
                  ")

                  FORCE="${{ inputs.force }}"
                  if [ "$DOMINATED" = "true" ] || [ "$FORCE" = "true" ]; then
                    echo "should-publish=true" >> "$GITHUB_OUTPUT"
                    echo ":box: Will publish: $LOCAL (registry: $REGISTRY)"
                  else
                    echo "should-publish=false" >> "$GITHUB_OUTPUT"
                    echo ":play: Skipping: $LOCAL is not newer than $REGISTRY"
                  fi

    publish:
        name: Publish to npm
        needs: check
        if: needs.check.outputs.should-publish == 'true'
        runs-on: ubuntu-latest
        environment: npm-publish
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  registry-url: "https://registry.npmjs.org"
                  cache: "npm"
                  cache-dependency-path: package-lock.json

            - name: Install dependencies
              run: npm install --ignore-scripts

            - name: Test
              run: npm test

            - name: Publish
              if: ${{ !inputs.dry-run }}
              run: npm publish --access public --provenance

            - name: Publish (dry run)
              if: ${{ inputs.dry-run }}
              run: npm publish --access public --dry-run

            - name: Verify publication
              if: ${{ !inputs.dry-run }}
              run: |
                  echo ":clock: Waiting for registry propagation..."
                  sleep 10
                  PUBLISHED=$(npm view bosun version 2>/dev/null || echo "NOT_FOUND")
                  EXPECTED="${{ needs.check.outputs.local-version }}"
                  if [ "$PUBLISHED" = "$EXPECTED" ]; then
                    echo ":check: Successfully published bosun@$PUBLISHED"
                  else
                    echo ":alert: Registry shows $PUBLISHED, expected $EXPECTED (may still be propagating)"
                  fi

            - name: Summary
              run: |
                  echo "## :box: Bosun Publish" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
                  echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Package | \`bosun\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Version | \`${{ needs.check.outputs.local-version }}\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Previous | \`${{ needs.check.outputs.registry-version }}\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Dry Run | \`${{ inputs.dry-run || 'false' }}\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Trigger | \`${{ github.event_name }}\` |" >> "$GITHUB_STEP_SUMMARY"
