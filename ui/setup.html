<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bosun â€” Setup Wizard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* â”€â”€ CSS Variables / Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg-primary: #0b0f14;
      --bg-secondary: #111722;
      --bg-card: #151c28;
      --bg-input: #1a2232;
      --bg-hover: #1e2940;
      --border-primary: #1e293b;
      --border-focus: #6366f1;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-dim: #64748b;
      --accent: #6366f1;
      --accent-light: #818cf8;
      --accent-glow: rgba(99, 102, 241, 0.25);
      --success: #22c55e;
      --success-bg: rgba(34, 197, 94, 0.1);
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.1);
      --error: #ef4444;
      --error-bg: rgba(239, 68, 68, 0.1);
      --radius: 10px;
      --radius-sm: 6px;
      --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.3);
      --font-sans: 'Sora', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-mono: 'JetBrains Mono', 'Cascadia Code', 'Fira Code', monospace;
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* â”€â”€ Reset / Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 15px; }
    body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      background-image:
        radial-gradient(circle at 20% 10%, rgba(76,201,240,.12), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(94,234,212,.08), transparent 45%),
        radial-gradient(circle at 50% 100%, rgba(59,130,246,.08), transparent 60%);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    a { color: var(--accent-light); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .setup-container {
      max-width: 720px;
      margin: 0 auto;
      padding: 32px 24px 64px;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .setup-header {
      text-align: center;
      margin-bottom: 32px;
    }
    .setup-logo {
      position: relative;
      width: 64px; height: 64px;
      margin: 0 auto 16px;
    }
    .setup-logo .ring {
      position: absolute; inset: 0;
      border-radius: 50%;
      border: 2px solid rgba(99,102,241,.15);
      animation: spin 3s linear infinite;
    }
    .setup-logo .ring-inner {
      position: absolute; inset: 6px;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: #6366f1;
      border-right-color: rgba(99,102,241,.4);
      animation: spin 1.5s linear infinite reverse;
    }
    .setup-logo .dot {
      position: absolute; top: 50%; left: 50%;
      width: 14px; height: 14px; margin: -7px 0 0 -7px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #a78bfa);
      box-shadow: 0 0 16px rgba(99,102,241,.5);
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .setup-title {
      font-size: 1.6rem; font-weight: 700;
      background: linear-gradient(135deg, #f1f5f9, #94a3b8);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .setup-subtitle { color: var(--text-dim); font-size: 0.9rem; margin-top: 4px; }

    /* â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .progress-bar {
      display: flex; align-items: center;
      gap: 0; margin-bottom: 32px;
      position: relative;
    }
    .progress-step {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      position: relative; z-index: 1;
      cursor: pointer; user-select: none;
    }
    .progress-step .step-dot {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--bg-card); border: 2px solid var(--border-primary);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 600; color: var(--text-dim);
      transition: all var(--transition);
    }
    .progress-step.active .step-dot {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
      box-shadow: 0 0 12px var(--accent-glow);
    }
    .progress-step.completed .step-dot {
      border-color: var(--success);
      background: var(--success);
      color: #fff;
    }
    .progress-step .step-label {
      font-size: 0.6rem; color: var(--text-dim);
      margin-top: 6px; white-space: nowrap;
      transition: color var(--transition);
    }
    .progress-step.active .step-label { color: var(--accent-light); font-weight: 500; }
    .progress-step.completed .step-label { color: var(--success); }
    .progress-line {
      position: absolute; top: 14px; left: 7%; right: 7%;
      height: 2px; background: var(--border-primary);
      z-index: 0;
    }
    .progress-line-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent));
      transition: width 0.4s ease;
    }

    /* â”€â”€ Card / Step Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .step-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius);
      padding: 28px;
      box-shadow: var(--shadow-card);
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .step-panel h2 {
      font-size: 1.15rem; font-weight: 600;
      margin-bottom: 6px;
    }
    .step-panel .step-desc {
      color: var(--text-secondary); font-size: 0.85rem;
      margin-bottom: 20px; line-height: 1.5;
    }

    /* â”€â”€ Form Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-group {
      margin-bottom: 18px;
    }
    .form-group label {
      display: block;
      font-size: 0.8rem; font-weight: 500; color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .form-group label .required { color: var(--error); }
    input[type="text"], input[type="number"], input[type="password"], select, textarea {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 0.85rem;
      transition: border-color var(--transition), box-shadow var(--transition);
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    select option { background: var(--bg-secondary); color: var(--text-primary); }
    textarea { resize: vertical; min-height: 80px; }
    .hint { font-size: 0.73rem; color: var(--text-dim); margin-top: 4px; }
    .field-error { font-size: 0.73rem; color: var(--error); margin-top: 4px; }
    .custom-input-row {
      display: flex; gap: 8px; margin-top: 8px;
    }
    .custom-input-row input { flex: 1; }

    /* â”€â”€ Checkmark / Status Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .prereq-list { list-style: none; }
    .prereq-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      font-size: 0.85rem;
    }
    .prereq-item .icon { font-size: 1rem; flex-shrink: 0; }
    .prereq-item .name { font-weight: 500; flex: 1; }
    .prereq-item .version { color: var(--text-dim); font-family: var(--font-mono); font-size: 0.75rem; }
    .prereq-item.ok { border-color: rgba(34,197,94,.2); }
    .prereq-item.warn { border-color: rgba(245,158,11,.2); }
    .prereq-item.fail { border-color: rgba(239,68,68,.2); }

    /* â”€â”€ Executor Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .executor-card {
      background: var(--bg-input);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-bottom: 12px;
    }
    .executor-card-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }
    .executor-card-header h4 { font-size: 0.9rem; font-weight: 500; }
    .executor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .executor-grid .form-group { margin-bottom: 0; }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 10px 20px;
      border: 1px solid var(--border-primary); border-radius: var(--radius-sm);
      background: var(--bg-card); color: var(--text-primary);
      font-family: var(--font-sans); font-size: 0.85rem; font-weight: 500;
      cursor: pointer; transition: all var(--transition);
      user-select: none;
    }
    .btn:hover { background: var(--bg-hover); border-color: var(--text-dim); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-primary {
      background: var(--accent); border-color: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { background: var(--accent-light); border-color: var(--accent-light); }
    .btn-success {
      background: var(--success); border-color: var(--success); color: #fff;
    }
    .btn-success:hover { opacity: 0.9; }
    .btn-sm { padding: 6px 12px; font-size: 0.78rem; }
    .btn-danger { border-color: var(--error); color: var(--error); }
    .btn-danger:hover { background: var(--error-bg); }
    .nav-buttons {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 24px; padding-top: 16px;
      border-top: 1px solid var(--border-primary);
    }
    .nav-buttons .spacer { flex: 1; }

    /* â”€â”€ Repo List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .repo-entry {
      display: flex; gap: 8px; align-items: center;
      margin-bottom: 8px;
    }
    .repo-entry input { flex: 1; }

    /* â”€â”€ Summary Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .summary-table {
      width: 100%;
      border-collapse: collapse;
    }
    .summary-table th, .summary-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-primary);
      font-size: 0.83rem;
    }
    .summary-table th {
      color: var(--text-dim); font-weight: 500;
      width: 160px;
    }
    .summary-table td {
      font-family: var(--font-mono); font-size: 0.8rem;
      word-break: break-all;
    }

    /* â”€â”€ Success Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .success-banner {
      text-align: center; padding: 40px 20px;
    }
    .success-banner .icon { font-size: 3rem; margin-bottom: 12px; }
    .success-banner h2 { color: var(--success); margin-bottom: 8px; }
    .success-banner p { color: var(--text-secondary); font-size: 0.9rem; }

    /* â”€â”€ Profile Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .profile-cards {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    }
    .profile-card {
      padding: 18px; border: 2px solid var(--border-primary);
      border-radius: var(--radius); background: var(--bg-input);
      cursor: pointer; transition: all var(--transition);
      text-align: center;
    }
    .profile-card:hover { border-color: var(--text-dim); background: var(--bg-hover); }
    .profile-card.selected { border-color: var(--accent); background: rgba(99,102,241,.08); }
    .profile-card .icon { font-size: 1.5rem; margin-bottom: 8px; }
    .profile-card h4 { font-size: 0.9rem; margin-bottom: 4px; }
    .profile-card p { font-size: 0.73rem; color: var(--text-dim); line-height: 1.4; }

    /* â”€â”€ Loading Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spinner {
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid var(--border-primary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 600px) {
      .setup-container { padding: 16px 12px 48px; }
      .step-panel { padding: 18px; }
      .executor-grid { grid-template-columns: 1fr; }
      .profile-cards { grid-template-columns: 1fr; }
      .progress-step .step-label { display: none; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="importmap">
  {
    "imports": {
      "preact":          "/vendor/preact.js",
      "preact/hooks":    "/vendor/preact-hooks.js",
      "htm":             "/vendor/htm.js"
    }
  }
  </script>

  <script type="module">
import { h, render } from "preact";
import { useState, useEffect, useRef } from "preact/hooks";
import htm from "htm";

const html = htm.bind(h);

// â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const api = (path, opts) =>
  fetch(`/api/setup/${path}`, {
    headers: { "Content-Type": "application/json" },
    ...opts,
  }).then((r) => r.json());

const apiGet = (path) => api(path);
const apiPost = (path, body) => api(path, { method: "POST", body: JSON.stringify(body) });

// â”€â”€ Steps definition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const STEPS = [
  { id: "prerequisites", label: "Prerequisites", icon: "âœ…" },
  { id: "profile", label: "Profile", icon: "ğŸ‘¤" },
  { id: "executors", label: "AI Executors", icon: "ğŸ¤–" },
  { id: "repos", label: "Repositories", icon: "ğŸ“" },
  { id: "kanban", label: "Task Mgmt", icon: "ğŸ“‹" },
  { id: "notifications", label: "Notifications", icon: "ğŸ””" },
  { id: "review", label: "Review", icon: "ğŸš€" },
];

// â”€â”€ SelectWithCustom component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function SelectWithCustom({ options, value, onChange, placeholder }) {
  const [isCustom, setIsCustom] = useState(false);
  const [customValue, setCustomValue] = useState("");
  const inputRef = useRef(null);

  const isKnown = options.some((o) => o.value === value);

  useEffect(() => {
    if (!isKnown && value && value !== "__custom__") {
      setIsCustom(true);
      setCustomValue(value);
    }
  }, []);

  const handleSelect = (e) => {
    if (e.target.value === "__custom__") {
      setIsCustom(true);
      setCustomValue(value || "");
      setTimeout(() => inputRef.current?.focus(), 50);
    } else {
      setIsCustom(false);
      setCustomValue("");
      onChange(e.target.value);
    }
  };

  const commitCustom = () => {
    if (customValue.trim()) onChange(customValue.trim());
  };

  const handleCustomKeyDown = (e) => {
    if (e.key === "Enter") { commitCustom(); e.target.blur(); }
  };

  return html`
    <select value=${isCustom ? "__custom__" : value} onchange=${handleSelect}>
      ${placeholder ? html`<option value="" disabled>${placeholder}</option>` : null}
      ${options.map((o) => html`<option value=${o.value}>${o.label}</option>`)}
      <option value="__custom__">Custom...</option>
    </select>
    ${isCustom && html`
      <div class="custom-input-row">
        <input
          ref=${inputRef}
          type="text"
          value=${customValue}
          oninput=${(e) => setCustomValue(e.target.value)}
          onblur=${commitCustom}
          onkeydown=${handleCustomKeyDown}
          placeholder="Enter model slug..."
        />
        <button class="btn btn-sm" onclick=${() => { setIsCustom(false); onChange(options[0]?.value || ""); }}>
          Cancel
        </button>
      </div>
    `}
  `;
}

// â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function App() {
  const [step, setStep] = useState(0);
  const [loading, setLoading] = useState(true);
  const [applying, setApplying] = useState(false);
  const [done, setDone] = useState(false);
  const [error, setError] = useState(null);

  // Data from API
  const [prereqs, setPrereqs] = useState(null);
  const [, setDefaults] = useState(null);
  const [models, setModels] = useState({});
  const [executorTypes, setExecutorTypes] = useState([]);
  const [kanbanBackends, setKanbanBackends] = useState([]);
  const [status, setStatus] = useState(null);

  // Config state
  const [profile, setProfile] = useState("standard");
  const [projectName, setProjectName] = useState("");
  const [repoSlug, setRepoSlug] = useState("");
  const [repoRoot, setRepoRoot] = useState("");
  const [executors, setExecutors] = useState([
    { name: "primary", executor: "COPILOT", model: "claude-opus-4.6", weight: 70, role: "primary", authMode: "oauth", apiKey: "", baseUrl: "" },
    { name: "backup", executor: "CODEX", model: "gpt-5.3-codex", weight: 30, role: "backup", authMode: "oauth", apiKey: "", baseUrl: "" },
  ]);
  const [probedModels, setProbedModels] = useState({});
  const [repos, setRepos] = useState([""]);
  const [kanbanBackend, setKanbanBackend] = useState("internal");
  const [telegramToken, setTelegramToken] = useState("");
  const [telegramChatId, setTelegramChatId] = useState("");
  const [maxParallel, setMaxParallel] = useState(6);
  const [maxRetries, setMaxRetries] = useState(3);
  const [failoverStrategy, setFailoverStrategy] = useState("next-in-line");
  const [completedSteps, setCompletedSteps] = useState(new Set());
  const [loadedFromEnv, setLoadedFromEnv] = useState(false);
  const [bosunHome, setBosunHome] = useState("");
  const [workspacesDir, setWorkspacesDir] = useState("");
  const [workspacesDirCustomized, setWorkspacesDirCustomized] = useState(false);
  const [telegramEnabled, setTelegramEnabled] = useState(false);
  const [jiraUrl, setJiraUrl] = useState("");
  const [jiraProjectKey, setJiraProjectKey] = useState("");
  const [jiraApiToken, setJiraApiToken] = useState("");
  const [githubProjectNumber, setGithubProjectNumber] = useState("");
  const [oauthStatus, setOauthStatus] = useState(null); // null | "pending" | "received"
  const [oauthInstallationId, setOauthInstallationId] = useState("");

  // â”€â”€ Load initial data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  useEffect(() => {
    Promise.all([
      apiGet("prerequisites"),
      apiGet("defaults"),
      apiGet("models"),
      apiGet("executors"),
      apiGet("status"),
    ]).then(([prereqData, defaultsData, modelsData, execData, statusData]) => {
      setPrereqs(prereqData.prerequisites);
      setDefaults(defaultsData.defaults);
      setModels(modelsData.models || {});
      setExecutorTypes(execData.executors || []);
      setKanbanBackends(execData.kanbanBackends || []);
      setStatus(statusData);

      // Apply defaults
      const d = defaultsData.defaults || {};
      if (d.projectName)     setProjectName(d.projectName);
      if (d.repoSlug)        setRepoSlug(d.repoSlug);
      if (d.repoRoot)        setRepoRoot(d.repoRoot);
      if (d.maxParallel)     setMaxParallel(d.maxParallel);
      if (d.maxRetries)      setMaxRetries(d.maxRetries);
      if (d.failoverStrategy) setFailoverStrategy(d.failoverStrategy);
      if (d.kanbanBackend)   setKanbanBackend(d.kanbanBackend);
      if (d.bosunHome)       setBosunHome(d.bosunHome);
      if (d.workspacesDir)   setWorkspacesDir(d.workspacesDir);

      // Pre-fill repos from existing config (slugs preferred)
      if (statusData.existingConfig?.repos?.length) {
        setRepos(statusData.existingConfig.repos.map((r) => r.slug || r.path || ""));
      } else if (d.repoSlug) {
        setRepos([d.repoSlug]);
      }

      // â”€â”€ Pre-fill from existing .env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const env = statusData.existingEnv || {};
      let envLoaded = false;
      if (env.BOSUN_HOME) { setBosunHome(env.BOSUN_HOME); envLoaded = true; }
      if (env.BOSUN_WORKSPACES_DIR) { setWorkspacesDir(env.BOSUN_WORKSPACES_DIR); setWorkspacesDirCustomized(true); envLoaded = true; }
      if (env.PROJECT_NAME) { setProjectName(env.PROJECT_NAME); envLoaded = true; }
      if (env.GITHUB_REPO) { setRepoSlug(env.GITHUB_REPO); envLoaded = true; }
      if (env.REPO_ROOT) { setRepoRoot(env.REPO_ROOT); envLoaded = true; }
      if (env.KANBAN_BACKEND) { setKanbanBackend(env.KANBAN_BACKEND); envLoaded = true; }
      if (env.TELEGRAM_BOT_TOKEN) { setTelegramToken(env.TELEGRAM_BOT_TOKEN); setTelegramEnabled(true); envLoaded = true; }
      if (env.TELEGRAM_CHAT_ID) { setTelegramChatId(env.TELEGRAM_CHAT_ID); envLoaded = true; }
      if (env.JIRA_URL) { setJiraUrl(env.JIRA_URL); envLoaded = true; }
      if (env.JIRA_PROJECT_KEY) { setJiraProjectKey(env.JIRA_PROJECT_KEY); envLoaded = true; }
      if (env.JIRA_API_TOKEN) { setJiraApiToken(env.JIRA_API_TOKEN); envLoaded = true; }
      if (env.GITHUB_PROJECT_NUMBER) { setGithubProjectNumber(env.GITHUB_PROJECT_NUMBER); envLoaded = true; }
      if (env.EXECUTORS) {
        try {
          const parsed = env.EXECUTORS.split(",").map((part, idx) => {
            const segments = part.trim().split(":");
            const execType = segments[0] || "COPILOT";
            const variant = segments[1] || "DEFAULT";
            const weight = Number(segments[2]) || 50;
            const model = variant === "DEFAULT" ? "" : variant.toLowerCase().replaceAll("_", "-");
            // Detect if an API key was previously configured for this executor type
            const hasApiKey =
              ((execType === "CODEX" || execType === "OPENAI") && !!env.OPENAI_API_KEY) ||
              ((execType === "CLAUDE_CODE" || execType === "ANTHROPIC") && !!env.ANTHROPIC_API_KEY);
            return {
              name: idx === 0 ? "primary" : `executor-${idx + 1}`,
              executor: execType,
              model,
              weight,
              role: idx === 0 ? "primary" : "backup",
              authMode: hasApiKey ? "api-key" : "oauth",
              apiKey: (execType === "CODEX" || execType === "OPENAI") ? (env.OPENAI_API_KEY || "") :
                       (execType === "CLAUDE_CODE" || execType === "ANTHROPIC") ? (env.ANTHROPIC_API_KEY || "") : "",
              baseUrl: (execType === "CODEX" || execType === "OPENAI") ? (env.OPENAI_BASE_URL || "") :
                        (execType === "CLAUDE_CODE" || execType === "ANTHROPIC") ? (env.ANTHROPIC_BASE_URL || "") : "",
            };
          });
          if (parsed.length > 0) { setExecutors(parsed); envLoaded = true; }
        } catch { /* ignore parse errors */ }
      }
      if (envLoaded) setLoadedFromEnv(true);

      setLoading(false);
    }).catch((err) => {
      setError(`Failed to connect to setup server: ${err.message}`);
      setLoading(false);
    });
  }, []);

  // Auto-update workspacesDir whenever bosunHome changes, unless the user has
  // manually set a custom workspaces path.
  useEffect(() => {
    if (!workspacesDirCustomized && bosunHome) {
      setWorkspacesDir(bosunHome.replace(/[/\\]*$/, "") + "/workspaces");
    }
  }, [bosunHome]);

  // â”€â”€ GitHub App OAuth callback detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // When the user authorises the Bosun GitHub App from the Marketplace:
  //   1. GitHub redirects to http://127.0.0.1:54317/github/callback?code=XXX
  //   2. The callback catcher saves the code and bounces the browser back here
  //      with ?oauth_code=XXX&installation_id=YYY in the URL
  //   3. OR â€” if the user installs first and then runs setup â€” the callback
  //      catcher wrote a file that we get via polling /api/setup/oauth-state
  useEffect(() => {
    // Check if GitHub just redirected back to us with the OAuth code
    const params = new URLSearchParams(window.location.search);
    const oauthCode = params.get("oauth_code");
    const installId = params.get("installation_id");
    const oauthOk   = params.get("oauth") === "success";
    if (oauthCode || oauthOk) {
      setOauthStatus("received");
      if (installId) setOauthInstallationId(installId);
      // Clean the URL params without a navigation so the wizard looks tidy
      const clean = window.location.pathname;
      window.history.replaceState({}, "", clean);
    }

    // Poll the setup server for a pending OAuth callback that may have been
    // received on the callback-catcher (port 54317) while setup was open.
    let pollTimer;
    const poll = async () => {
      try {
        const r = await fetch("/api/setup/oauth-state");
        if (!r.ok) return;
        const data = await r.json();
        if (data?.pending) {
          setOauthStatus("received");
          if (data.installation_id) setOauthInstallationId(data.installation_id);
          clearInterval(pollTimer);
        }
      } catch { /* server may not have this endpoint yet â€” ignore */ }
    };
    pollTimer = setInterval(poll, 2000);
    poll(); // immediate first check
    return () => clearInterval(pollTimer);
  }, []);



  const goNext = () => {
    setCompletedSteps((prev) => new Set([...prev, step]));
    setStep((s) => Math.min(s + 1, STEPS.length - 1));
  };
  const goPrev = () => setStep((s) => Math.max(s - 1, 0));
  const goTo = (idx) => {
    if (idx <= step || completedSteps.has(idx)) setStep(idx);
  };

  // â”€â”€ Build EXECUTORS env string â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const buildExecutorsEnv = () =>
    executors
      .map((ex) => {
        const variant = (ex.model || "DEFAULT").toUpperCase().replaceAll("-", "_");
        return `${ex.executor}:${variant}:${ex.weight}`;
      })
      .join(",");

  const buildExecutorsConfig = () =>
    executors.map((ex) => ({
      name: ex.name,
      executor: ex.executor,
      variant: (ex.model || "DEFAULT").toUpperCase().replaceAll("-", "_"),
      weight: Number(ex.weight) || 50,
      role: ex.role,
      authMode: ex.authMode || "oauth",
      apiKey: ex.authMode === "api-key" ? (ex.apiKey || "") : "",
      baseUrl: ex.authMode === "api-key" ? (ex.baseUrl || "") : "",
    }));

  // â”€â”€ Apply config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const handleApply = async () => {
    setApplying(true);
    setError(null);
    try {
      const filteredRepos = repos.filter((r) => r.trim());
      const result = await apiPost("apply", {
        env: {
          bosunHome,
          workspacesDir,
          projectName,
          repoSlug,
          repoRoot,
          executors: buildExecutorsEnv(),
          kanbanBackend,
          maxParallel,
          maxRetries,
          failoverStrategy,
          telegramToken: telegramEnabled ? telegramToken : "",
          telegramChatId: telegramEnabled ? telegramChatId : "",
          jiraUrl,
          jiraProjectKey,
          jiraApiToken,
          githubProjectNumber,
        },
        configJson: {
          projectName,
          bosunHome,
          workspacesDir,
          executors: buildExecutorsConfig(),
          repos: filteredRepos.map((r) => ({ slug: r })),
          kanban: { backend: kanbanBackend },
          failover: {
            strategy: failoverStrategy,
            maxRetries: Number(maxRetries) || 3,
            cooldownMinutes: 5,
            disableOnConsecutiveFailures: 3,
          },
          distribution: "weighted",
        },
      });

      if (result.ok) {
        setDone(true);
        // Feed the actual bosunHome/workspacesDir back from the server result
        if (result.bosunHome)    setBosunHome(result.bosunHome);
        if (result.workspacesDir) setWorkspacesDir(result.workspacesDir);
        // Signal server to shut down
        setTimeout(() => apiPost("complete", {}), 1500);
      } else {
        setError(result.error || "Unknown error applying config");
      }
    } catch (err) {
      setError(err.message);
    }
    setApplying(false);
  };

  // â”€â”€ Helpers for models dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const getModelsForExecutor = (execType) => {
    const key = execType === "COPILOT" ? "copilot"
      : execType === "CODEX" ? "codex"
      : execType === "CLAUDE_CODE" ? "claude"
      : "copilot";
    return models[key] || [];
  };

  const getDefaultModelForExecutor = (execType) => {
    const opts = getModelsForExecutor(execType);
    const recommended = opts.find((o) => o.recommended);
    return recommended?.value || opts[0]?.value || "";
  };

  // â”€â”€ Executor management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const addExecutor = () => {
    setExecutors((prev) => [
      ...prev,
      {
        name: `executor-${prev.length + 1}`,
        executor: "COPILOT",
        model: "claude-sonnet-4",
        weight: 50,
        role: "backup",
        authMode: "oauth",
        apiKey: "",
        baseUrl: "",
      },
    ]);
  };

  const removeExecutor = (idx) => {
    setExecutors((prev) => prev.filter((_, i) => i !== idx));
  };

  const updateExecutor = (idx, field, value) => {
    setExecutors((prev) => {
      const updated = [...prev];
      updated[idx] = { ...updated[idx], [field]: value };
      // When executor type changes, update model to default for that type
      if (field === "executor") {
        updated[idx].model = getDefaultModelForExecutor(value);
      }
      return updated;
    });
  };

  const probeExecutorModels = async (idx) => {
    const ex = executors[idx];
    if (!ex) return;
    setProbedModels((prev) => ({ ...prev, [idx]: { loading: true, models: [], source: "" } }));
    try {
      const result = await apiPost("models/probe", {
        executor: ex.executor,
        apiKey: ex.apiKey || "",
        baseUrl: ex.baseUrl || "",
      });
      setProbedModels((prev) => ({
        ...prev,
        [idx]: {
          loading: false,
          models: result.models || [],
          source: result.source || "static",
          warning: result.warning || "",
          note: result.note || "",
        },
      }));
      // Auto-select first live model if current model isn't in the new list
      if (result.models?.length) {
        const current = ex.model;
        const inList = result.models.some((m) => m.value === current);
        if (!inList) {
          const rec = result.models.find((m) => m.recommended) || result.models[0];
          if (rec) updateExecutor(idx, "model", rec.value);
        }
      }
    } catch (err) {
      setProbedModels((prev) => ({
        ...prev,
        [idx]: { loading: false, models: [], source: "error", warning: err.message },
      }));
    }
  };

  // â”€â”€ Repo management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const addRepo = () => setRepos((prev) => [...prev, ""]);
  const removeRepo = (idx) => setRepos((prev) => prev.filter((_, i) => i !== idx));
  const updateRepo = (idx, value) => {
    setRepos((prev) => { const u = [...prev]; u[idx] = value; return u; });
  };

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if (loading) {
    return html`
      <div class="setup-container" style="text-align:center;padding-top:120px">
        <div class="setup-logo">
          <div class="ring"></div>
          <div class="ring-inner"></div>
          <div class="dot"></div>
        </div>
        <div style="margin-top:16px;color:var(--text-dim)">Loading setup wizard...</div>
        <div style="margin-top:8px"><span class="spinner"></span></div>
      </div>
    `;
  }

  if (done) {
    return html`
      <div class="setup-container">
        <div class="step-panel">
          <div class="success-banner">
            <div class="icon">ğŸ‰</div>
            <h2>Setup Complete!</h2>
            <p>Bosun is configured and ready to go.</p>
            <p style="margin-top:12px;font-size:0.8rem;color:var(--text-dim)">
              Bosun home: <code style="font-family:var(--font-mono);color:var(--accent-light)">${bosunHome || status?.bosunHome || "~/bosun"}</code>
            </p>
            <p style="margin-top:4px;font-size:0.8rem;color:var(--text-dim)">
              Workspaces: <code style="font-family:var(--font-mono);color:var(--accent-light)">${workspacesDir || status?.workspacesDir || "~/bosun/workspaces"}</code>
            </p>
            <p style="margin-top:16px;color:var(--text-secondary)">
              You can close this tab. Run <code style="font-family:var(--font-mono);color:var(--accent-light)">bosun</code> to start the orchestrator.
            </p>
          </div>
        </div>
      </div>
    `;
  }

  // â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const progressPercent = step / (STEPS.length - 1) * 100;
  const ProgressBar = () => html`
    <div class="progress-bar">
      <div class="progress-line">
        <div class="progress-line-fill" style="width:${progressPercent}%"></div>
      </div>
      ${STEPS.map((s, i) => html`
        <div class="progress-step ${i === step ? "active" : ""} ${completedSteps.has(i) ? "completed" : ""}" onclick=${() => goTo(i)}>
          <div class="step-dot">${completedSteps.has(i) ? "âœ“" : i + 1}</div>
          <div class="step-label">${s.label}</div>
        </div>
      `)}
    </div>
  `;

  // â”€â”€ Step 0: Prerequisites â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const StepPrerequisites = () => {
    if (!prereqs) return html`<div class="spinner"></div>`;

    const items = [
      { key: "git", label: "Git", ...prereqs.git },
      { key: "gh", label: "GitHub CLI (gh)", ...prereqs.gh },
      { key: "node", label: "Node.js", ...prereqs.node },
      { key: "pwsh", label: "PowerShell (pwsh)", ...prereqs.pwsh },
    ];

    const allOk = items.filter((i) => i.required).every((i) => i.installed);

    return html`
      <h2>Prerequisites Check</h2>
      <p class="step-desc">Verifying required tools are installed and available.</p>
      <ul class="prereq-list">
        ${items.map((item) => {
          const statusClass = item.installed ? "ok" : item.required ? "fail" : "warn";
          const icon = item.installed ? "âœ…" : item.required ? "âŒ" : "âš ï¸";
          return html`
            <li class="prereq-item ${statusClass}">
              <span class="icon">${icon}</span>
              <span class="name">${item.label}${!item.required ? " (optional)" : ""}</span>
              <span class="version">${item.version || (item.installed ? "found" : "not found")}</span>
            </li>
          `;
        })}
        ${prereqs.gh && !prereqs.gh.authenticated && prereqs.gh.installed ? html`
          <li class="prereq-item warn">
            <span class="icon">âš ï¸</span>
            <span class="name">GitHub CLI not authenticated</span>
            <span class="version">Run: gh auth login</span>
          </li>
        ` : null}
      </ul>
      <div class="nav-buttons">
        <div class="spacer"></div>
        <button class="btn btn-primary" onclick=${goNext} disabled=${!allOk}>
          ${allOk ? "Continue â†’" : "Fix issues above to continue"}
        </button>
      </div>
    `;
  };

  // â”€â”€ Step 1: Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const StepProfile = () => html`
    <h2>Setup Profile</h2>
    <p class="step-desc">Choose how you'd like to configure bosun, then set your home directory.</p>

    <div class="form-group">
      <label>Bosun Home Directory <span class="required">*</span></label>
      <input type="text" value=${bosunHome}
        oninput=${(e) => setBosunHome(e.target.value)}
        placeholder="~/bosun" />
      <div class="hint">
        Single root for all bosun data: configs, global tool settings, and every workspace.
        Keep this <strong>outside</strong> any git repo.
        Bosun creates this folder automatically â€” it will never touch anything outside it.
      </div>
    </div>
    <div class="form-group">
      <label>Workspaces Directory</label>
      <input type="text" value=${workspacesDir}
        oninput=${(e) => { setWorkspacesDir(e.target.value); setWorkspacesDirCustomized(true); }}
        placeholder="${bosunHome}/workspaces" />
      <div class="hint">
        Bosun clones and manages every project repo here, and stores shared global settings
        (<code style="font-family:var(--font-mono)">.codex/</code>,
         <code style="font-family:var(--font-mono)">.vscode/</code>,
         <code style="font-family:var(--font-mono)">.bosun/hooks/</code>) in this folder.
        ${workspacesDirCustomized ? html`
          <a href="#" onclick=${(e) => { e.preventDefault(); setWorkspacesDirCustomized(false); setWorkspacesDir(bosunHome.replace(/[/\\]*$/, "") + "/workspaces"); }}
            style="margin-left:6px">Reset to default</a>
        ` : null}
      </div>
    </div>

    <div class="profile-cards">
      <div class="profile-card ${profile === "standard" ? "selected" : ""}" onclick=${() => setProfile("standard")}>
        <div class="icon">âš¡</div>
        <h4>Standard</h4>
        <p>Sensible defaults with primary & backup executors. Best for most users.</p>
      </div>
      <div class="profile-card ${profile === "advanced" ? "selected" : ""}" onclick=${() => setProfile("advanced")}>
        <div class="icon">ğŸ”§</div>
        <h4>Advanced</h4>
        <p>Full control over executors, failover, distribution weights, and all settings.</p>
      </div>
    </div>
    <div class="form-group" style="margin-top:20px">
      <label>Project Name <span class="required">*</span></label>
      <input type="text" value=${projectName} oninput=${(e) => setProjectName(e.target.value)} placeholder="my-project" />
      <div class="hint">Display name for your project in bosun's UI and notifications.</div>
    </div>
    <div class="form-group">
      <label>GitHub Repository</label>
      <input type="text" value=${repoSlug} oninput=${(e) => setRepoSlug(e.target.value)} placeholder="owner/repo" />
      <div class="hint">Optional. Used for PR automation, status checks, and GitHub project sync.</div>
    </div>
    <div class="nav-buttons">
      <button class="btn" onclick=${goPrev}>â† Back</button>
      <button class="btn btn-primary" onclick=${goNext} disabled=${!projectName.trim() || !bosunHome.trim()}>Continue â†’</button>
    </div>
  `;

  // â”€â”€ Step 2: AI Executors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const StepExecutors = () => html`
    <h2>AI Executors</h2>
    <p class="step-desc">Configure which AI coding agents bosun will use. You can add multiple executors with weighted distribution.</p>

    <div style="background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.25);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:16px;font-size:0.8rem;line-height:1.6">
      <strong>ğŸ” No API key required in most cases.</strong>
      GitHub Copilot, Codex CLI, and Claude Code all support OAuth â€” just run
      <code style="font-family:var(--font-mono);color:var(--accent-light)">gh auth login</code>,
      <code style="font-family:var(--font-mono);color:var(--accent-light)">codex auth login</code>, or
      <code style="font-family:var(--font-mono);color:var(--accent-light)">claude login</code>
      before starting Bosun and it will automatically use your authenticated session.
      Only provide an API key if you need a custom endpoint, a different account, or your own usage quota.
    </div>

    ${executors.map((ex, i) => {
      const probed = probedModels[i] || {};
      const modelOptions = probed.models?.length ? probed.models : getModelsForExecutor(ex.executor);
      const authMode = ex.authMode || "oauth";
      return html`
      <div class="executor-card">
        <div class="executor-card-header">
          <h4>${ex.role === "primary" ? "ğŸŸ¢" : "ğŸ”µ"} Executor ${i + 1}: ${ex.name}</h4>
          ${executors.length > 1 && html`
            <button class="btn btn-sm btn-danger" onclick=${() => removeExecutor(i)}>Remove</button>
          `}
        </div>
        <div class="executor-grid">
          <div class="form-group">
            <label>Name</label>
            <input type="text" value=${ex.name} oninput=${(e) => updateExecutor(i, "name", e.target.value)} placeholder="executor-name" />
          </div>
          <div class="form-group">
            <label>Role</label>
            <select value=${ex.role} onchange=${(e) => updateExecutor(i, "role", e.target.value)}>
              <option value="primary">Primary</option>
              <option value="backup">Backup</option>
            </select>
          </div>
          <div class="form-group">
            <label>Executor Type</label>
            <${SelectWithCustom}
              options=${executorTypes}
              value=${ex.executor}
              onChange=${(v) => updateExecutor(i, "executor", v)}
            />
          </div>
          <div class="form-group">
            <label>Authentication</label>
            <select value=${authMode} onchange=${(e) => updateExecutor(i, "authMode", e.target.value)}>
              <option value="oauth">Use existing auth (OAuth / login session)</option>
              <option value="api-key">API Key</option>
            </select>
            <div class="hint">
              ${authMode === "oauth"
                ? "Bosun will use your existing login session. No API key stored."
                : "Your API key will be saved to .env in BOSUN_HOME (never committed to git)."}
            </div>
          </div>
          ${authMode === "api-key" && html`
            <div class="form-group" style="grid-column:1/-1">
              <label>API Key</label>
              <input type="password" value=${ex.apiKey || ""}
                oninput=${(e) => updateExecutor(i, "apiKey", e.target.value)}
                placeholder="${ex.executor === "CLAUDE_CODE" ? "sk-ant-..." : "sk-..."}" />
              <div class="hint">
                For Codex: <code style="font-family:var(--font-mono)">OPENAI_API_KEY</code>.
                For Claude Code: <code style="font-family:var(--font-mono)">ANTHROPIC_API_KEY</code>.
              </div>
            </div>
            <div class="form-group" style="grid-column:1/-1">
              <label>Base URL <span style="font-weight:400;color:var(--text-dim)">(optional)</span></label>
              <input type="text" value=${ex.baseUrl || ""}
                oninput=${(e) => updateExecutor(i, "baseUrl", e.target.value)}
                placeholder="https://api.openai.com  or  https://<resource>.openai.azure.com/" />
              <div class="hint">Leave blank for the default endpoint. Set for Azure, self-hosted, or OpenAI-compatible APIs.</div>
            </div>
          `}
          <div class="form-group">
            <label style="display:flex;align-items:center;justify-content:space-between">
              <span>Model</span>
              ${ex.executor !== "COPILOT" && html`
                <button class="btn btn-sm" style="padding:3px 8px;font-size:0.72rem"
                  onclick=${() => probeExecutorModels(i)}
                  disabled=${probed.loading}>
                  ${probed.loading ? html`<span class="spinner" style="width:10px;height:10px"></span>` : "â†º Probe"}
                </button>
              `}
            </label>
            <${SelectWithCustom}
              options=${modelOptions}
              value=${ex.model}
              onChange=${(v) => updateExecutor(i, "model", v)}
            />
            ${probed.source === "live" && html`
              <div class="hint" style="color:var(--success)">âœ“ Live model list from API (${modelOptions.length} models)</div>
            `}
            ${probed.warning && html`
              <div class="hint" style="color:var(--warning, #f59e0b)">${probed.warning}</div>
            `}
            ${probed.note && html`
              <div class="hint">${probed.note}</div>
            `}
          </div>
          <div class="form-group">
            <label>Weight</label>
            <input type="number" value=${ex.weight} min="1" max="100"
              oninput=${(e) => updateExecutor(i, "weight", Number(e.target.value) || 50)} />
            <div class="hint">Distribution weight (higher = more tasks)</div>
          </div>
        </div>
      </div>
    `})}
    <button class="btn btn-sm" onclick=${addExecutor} style="margin-bottom:12px">+ Add Executor</button>
    ${profile === "advanced" && html`
      <div class="executor-grid" style="margin-top:12px">
        <div class="form-group">
          <label>Max Parallel</label>
          <input type="number" value=${maxParallel} min="1" max="20"
            oninput=${(e) => setMaxParallel(Number(e.target.value) || 6)} />
          <div class="hint">Simultaneous execution slots</div>
        </div>
        <div class="form-group">
          <label>Max Retries</label>
          <input type="number" value=${maxRetries} min="0" max="10"
            oninput=${(e) => setMaxRetries(Number(e.target.value) || 3)} />
        </div>
        <div class="form-group">
          <label>Failover Strategy</label>
          <select value=${failoverStrategy} onchange=${(e) => setFailoverStrategy(e.target.value)}>
            <option value="next-in-line">Next in Line</option>
            <option value="round-robin">Round Robin</option>
            <option value="random">Random</option>
          </select>
        </div>
      </div>
    `}
    <div class="nav-buttons">
      <button class="btn" onclick=${goPrev}>â† Back</button>
      <button class="btn btn-primary" onclick=${goNext} disabled=${executors.length === 0}>Continue â†’</button>
    </div>
  `;

  // â”€â”€ Step 3: Repositories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const StepRepos = () => {
    // Show the projected clone root for this project
    const cloneRoot = workspacesDir
      ? workspacesDir.replace(/[/\\]*$/, "") + "/" + (projectName || "<project>")
      : "<workspaces>/<project>";

    return html`
      <h2>Repositories</h2>
      <p class="step-desc">
        Add the GitHub repos bosun should work on.
        Bosun will clone them into your workspace and set up hooks, prompts, and configs automatically.
      </p>
      <div style="background:var(--bg-input);border:1px solid var(--border-primary);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:16px;font-size:0.78rem;color:var(--text-secondary)">
        ğŸ“ Repos will be cloned into:
        <code style="font-family:var(--font-mono);color:var(--accent-light);margin-left:4px">${cloneRoot}/&lt;repo-name&gt;</code>
      </div>
      ${repos.map((repo, i) => html`
        <div class="repo-entry">
          <input type="text" value=${repo} oninput=${(e) => updateRepo(i, e.target.value)}
            placeholder="owner/repo  or  https://github.com/owner/repo" />
          ${repos.length > 1 && html`
            <button class="btn btn-sm btn-danger" onclick=${() => removeRepo(i)}>âœ•</button>
          `}
        </div>
      `)}
      <button class="btn btn-sm" onclick=${addRepo} style="margin-top:4px">+ Add Repository</button>
      <div class="hint" style="margin-top:8px">
        Per-workspace settings live at <code style="font-family:var(--font-mono)">&lt;workspace&gt;/.bosun/</code> â€” hooks, prompts, and
        configs there override the global workspace defaults.
      </div>
      <div class="nav-buttons">
        <button class="btn" onclick=${goPrev}>â† Back</button>
        <button class="btn btn-primary" onclick=${goNext}>Continue â†’</button>
      </div>
    `;
  };

  // â”€â”€ Step 4: Task Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const StepKanban = () => html`
    <h2>Task Management</h2>
    <p class="step-desc">Choose how bosun tracks tasks and issues for your AI agents.</p>
    <div class="form-group">
      <label>Kanban Backend</label>
      <${SelectWithCustom}
        options=${kanbanBackends}
        value=${kanbanBackend}
        onChange=${setKanbanBackend}
      />
      <div class="hint">
        ${kanbanBackend === "internal" ? "Uses a local SQLite database for fast, offline task tracking." :
          kanbanBackend === "github" ? "Syncs with GitHub Projects. Requires a GitHub repo configured above." :
          kanbanBackend === "jira" ? "Two-way sync with Jira boards. Configure your Jira connection below." :
          "Custom backend â€” make sure you have the integration module."}
      </div>
    </div>
    ${kanbanBackend === "jira" && html`
      <div class="form-group">
        <label>Jira URL <span class="required">*</span></label>
        <input type="text" value=${jiraUrl} oninput=${(e) => setJiraUrl(e.target.value)}
          placeholder="https://yourorg.atlassian.net" />
        <div class="hint">Your Jira instance base URL.</div>
      </div>
      <div class="form-group">
        <label>Jira Project Key <span class="required">*</span></label>
        <input type="text" value=${jiraProjectKey} oninput=${(e) => setJiraProjectKey(e.target.value)}
          placeholder="PROJ" />
        <div class="hint">The Jira project key (e.g. PROJ, DEV, MYAPP).</div>
      </div>
      <div class="form-group">
        <label>Jira API Token</label>
        <input type="password" value=${jiraApiToken} oninput=${(e) => setJiraApiToken(e.target.value)}
          placeholder="Jira API token..." />
        <div class="hint">Create at <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank">Atlassian API tokens</a>. Used as the password with your Jira email.</div>
      </div>
    `}
    ${kanbanBackend === "github" && html`
      <div class="form-group">
        <label>GitHub Project Number</label>
        <input type="number" value=${githubProjectNumber} oninput=${(e) => setGithubProjectNumber(e.target.value)}
          placeholder="1" />
        <div class="hint">The number in the GitHub Projects URL: github.com/org/repo/projects/<strong>1</strong></div>
      </div>
    `}
    <div class="nav-buttons">
      <button class="btn" onclick=${goPrev}>â† Back</button>
      <button class="btn btn-primary" onclick=${goNext}>Continue â†’</button>
    </div>
  `;

  // â”€â”€ Step 5: Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const StepNotifications = () => html`
    <h2>Notifications</h2>
    <p class="step-desc">Optional: configure Telegram notifications for task progress, errors, and PR updates.</p>

    ${/* â”€â”€ GitHub App installation callout â”€â”€ */ ""}
    <div style="background:rgba(56,139,253,.07);border:1px solid rgba(56,139,253,.25);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:20px">
      <div style="display:flex;align-items:flex-start;gap:10px">
        <span style="font-size:1.3em;line-height:1.2;flex-shrink:0">ğŸ“¦</span>
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:0.9rem;color:var(--accent-light);margin-bottom:4px">GitHub App â€” Bosun[botswain]</div>
          ${oauthStatus === "received"
            ? html`<div style="color:#4ade80;font-size:0.82rem">
                âœ… GitHub App authorized!
                ${oauthInstallationId ? html` (Installation <code style="font-family:var(--font-mono)">${oauthInstallationId}</code>)` : null}
              </div>`
            : html`<div style="font-size:0.82rem;color:var(--text-secondary);line-height:1.5">
                Install the Bosun GitHub App to enable rich PR integration and automatic task routing.
                <strong style="color:var(--text-primary)"> Keep this setup wizard open</strong> while
                you complete the Marketplace installation â€” the callback will be caught automatically.
                <div style="margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                  <a href="https://github.com/apps/bosun-botswain" target="_blank" rel="noopener"
                     style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--accent);color:#fff;border-radius:5px;font-size:0.8rem;font-weight:600;text-decoration:none">
                    ğŸ”— Install from GitHub Marketplace
                  </a>
                  <span style="font-size:0.75rem;color:var(--text-dim)">
                    <span class="spinner" style="width:10px;height:10px;border-width:2px;vertical-align:middle;margin-right:4px"></span>
                    Waiting for authorizationâ€¦
                  </span>
                </div>
              </div>`
          }
        </div>
      </div>
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none">
        <input type="checkbox" checked=${telegramEnabled}
          onchange=${(e) => setTelegramEnabled(e.target.checked)}
          style="width:auto;padding:0;margin:0;accent-color:var(--accent);cursor:pointer" />
        Enable Telegram Notifications
        ${telegramEnabled && loadedFromEnv ? html`<span style="font-size:0.7rem;color:var(--success);margin-left:4px">â— loaded from .env</span>` : null}
      </label>
    </div>
    ${telegramEnabled && html`
      <div class="form-group">
        <label>Telegram Bot Token</label>
        <input type="password" value=${telegramToken} oninput=${(e) => setTelegramToken(e.target.value)}
          placeholder="123456:ABCdefGHIjklMNO..." />
        <div class="hint">Create a bot via <a href="https://t.me/botfather" target="_blank">@BotFather</a>.</div>
      </div>
      <div class="form-group">
        <label>Telegram Chat ID</label>
        <input type="text" value=${telegramChatId} oninput=${(e) => setTelegramChatId(e.target.value)}
          placeholder="-1001234567890" />
        <div class="hint">Use <code style="font-family:var(--font-mono)">bosun --get-chat-id</code> to find your chat ID after the bot is running.</div>
      </div>
    `}
    <div class="nav-buttons">
      <button class="btn" onclick=${goPrev}>â† Back</button>
      <button class="btn btn-primary" onclick=${goNext}>Continue â†’</button>
    </div>
  `;

  // â”€â”€ Step 6: Review & Apply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const StepReview = () => {
    const filteredRepos = repos.filter((r) => r.trim());

    return html`
      <h2>Review & Apply</h2>
      <p class="step-desc">Review your configuration before applying. You can go back to change any section.</p>
      <table class="summary-table">
        <tbody>
          <tr><th>Bosun Home</th><td>${bosunHome || status?.bosunHome || "~/bosun"}</td></tr>
          <tr><th>Workspaces</th><td>${workspacesDir || status?.workspacesDir || "~/bosun/workspaces"}</td></tr>
          <tr><th>Project</th><td>${projectName}</td></tr>
          <tr><th>GitHub Repo</th><td>${repoSlug || "â€”"}</td></tr>
          <tr>
            <th>Executors</th>
            <td>
              ${executors.map((ex) => html`
                <div style="margin-bottom:4px">
                  <strong>${ex.name}</strong> â€” ${ex.executor} / ${ex.model} (weight: ${ex.weight}, ${ex.role})
                </div>
              `)}
            </td>
          </tr>
          <tr>
            <th>Repositories</th>
            <td>${filteredRepos.length > 0 ? filteredRepos.join(", ") : "â€”"}</td>
          </tr>
          <tr><th>Kanban Backend</th><td>${kanbanBackend}</td></tr>
          <tr><th>Telegram</th><td>${telegramEnabled && telegramToken ? "Configured" : "Skipped"}</td></tr>
          ${profile === "advanced" ? html`
            <tr><th>Max Parallel</th><td>${maxParallel}</td></tr>
            <tr><th>Max Retries</th><td>${maxRetries}</td></tr>
            <tr><th>Failover</th><td>${failoverStrategy}</td></tr>
          ` : null}
        </tbody>
      </table>
      ${error && html`<div class="field-error" style="margin-top:12px">${error}</div>`}
      <div class="nav-buttons">
        <button class="btn" onclick=${goPrev}>â† Back</button>
        <button class="btn btn-success" onclick=${handleApply} disabled=${applying}>
          ${applying ? html`<span class="spinner"></span> Applying...` : "Apply Configuration âœ“"}
        </button>
      </div>
    `;
  };

  // â”€â”€ Step Router â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // NOTE: Steps are called as plain functions (not <${Component} />) so Preact
  // diffs them inline â€” prevents the component-identity churn that causes
  // inputs to lose focus on every keystroke.

  const renderStep = () => {
    switch (step) {
      case 0: return StepPrerequisites();
      case 1: return StepProfile();
      case 2: return StepExecutors();
      case 3: return StepRepos();
      case 4: return StepKanban();
      case 5: return StepNotifications();
      case 6: return StepReview();
      default: return StepPrerequisites();
    }
  };

  return html`
    <div class="setup-container">
      <div class="setup-header">
        <div class="setup-logo">
          <div class="ring"></div>
          <div class="ring-inner"></div>
          <div class="dot"></div>
        </div>
        <div class="setup-title">Bosun Setup</div>
        <div class="setup-subtitle">v${status?.version || ""} â€” Configure your AI orchestrator</div>
      </div>
      ${loadedFromEnv && html`
        <div style="background:var(--success-bg);border:1px solid rgba(34,197,94,.3);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:16px;font-size:0.8rem;color:var(--success);display:flex;align-items:center;gap:8px">
          <span>âœ“</span>
          <span>Existing config detected â€” fields pre-filled from your <code style="font-family:var(--font-mono);color:var(--success)">.env</code>. Review each step and press Continue, or adjust as needed.</span>
        </div>
      `}
      ${oauthStatus === "received" && html`
        <div style="background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.35);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:16px;font-size:0.85rem;color:#4ade80;display:flex;align-items:flex-start;gap:10px">
          <span style="font-size:1.2em;line-height:1">âœ…</span>
          <div>
            <strong>GitHub App authorized!</strong>
            ${oauthInstallationId && html` Installation ID: <code style="font-family:var(--font-mono);font-size:0.8em;color:#86efac">${oauthInstallationId}</code>.`}
            ${" "}Complete the remaining steps to finish configuration.
          </div>
        </div>
      `}
      <${ProgressBar} />
      <div class="step-panel">
        ${renderStep()}
      </div>
    </div>
  `;
}

render(html`<${App} />`, document.getElementById("app"));
  </script>
</body>
<script defer src="https://cloud.umami.is/script.js" data-website-id="24c5d605-7f25-4be5-875e-25c8f3cb4059"></script>
</html>
