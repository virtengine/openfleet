<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; img-src * data: blob:; connect-src *;" />
  <title>Bosun MiniApp ‚Äî Demo Mode</title>

  <!-- Telegram WebApp SDK is fully mocked below ‚Äî no real SDK needed -->

  <!-- Import map ‚Äî same as the real app -->
  <script type="importmap">
  {
    "imports": {
      "preact":          "https://esm.sh/preact@10.25.4",
      "preact/hooks":    "https://esm.sh/preact@10.25.4/hooks",
      "preact/compat":   "https://esm.sh/preact@10.25.4/compat",
      "htm":             "https://esm.sh/htm@3.1.1",
      "@preact/signals": "https://esm.sh/@preact/signals@1.3.1?deps=preact@10.25.4"
    }
  }
  </script>

  <!-- Load the real MiniApp styles -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="styles/kanban.css" />
  <link rel="stylesheet" href="styles/sessions.css" />

  <!-- Fonts (match site) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <style>
    /* ‚ïê‚ïê‚ïê DEMO LAYOUT ‚Äî Two views: Telegram Chat + MiniApp ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    *, *::before, *::after { box-sizing: border-box; }
    html { height: 100%; margin: 0; }
    body { height: 100%; margin: 0; font-family: -apple-system, 'SF Pro Text', 'Helvetica Neue', 'Inter', sans-serif; background: #0e1621; color: #e8edf2; overflow: hidden; }

    /* Demo banner */
    .demo-banner { position: fixed; top: 0; left: 0; right: 0; z-index: 99999; background: linear-gradient(135deg, #60cc5d, #4caf50); color: #000; text-align: center; font-size: 11px; font-weight: 700; padding: 3px 8px; letter-spacing: 0.05em; text-transform: uppercase; }

    /* ‚îÄ‚îÄ VIEW CONTAINER ‚îÄ‚îÄ */
    .demo-views { position: fixed; top: 22px; left: 0; right: 0; bottom: 0; }

    /* ‚îÄ‚îÄ TELEGRAM CHAT VIEW ‚îÄ‚îÄ */
    .tg-view { position: absolute; inset: 0; display: flex; flex-direction: column; background: #0e1621; transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s; }
    .tg-view.hidden { transform: translateY(100%); opacity: 0; pointer-events: none; }

    /* Chat header */
    .tg-header { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: #17212b; border-bottom: 1px solid #1b2838; flex-shrink: 0; }
    .tg-header-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #4cc9f0, #60cc5d); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .tg-header-info { flex: 1; min-width: 0; }
    .tg-header-name { font-size: 15px; font-weight: 600; color: #fff; }
    .tg-header-status { font-size: 12px; color: #4cc9f0; }

    /* Chat messages area */
    .tg-messages { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 8px 0; display: flex; flex-direction: column; -webkit-overflow-scrolling: touch; }
    .tg-messages-spacer { flex: 1; } /* pushes messages to bottom initially */

    /* Message bubble */
    .tg-msg { padding: 2px 10px; max-width: 92%; animation: msgIn 0.2s ease-out; }
    .tg-msg-name { font-size: 12px; font-weight: 600; color: #4cc9f0; margin-bottom: 1px; }
    .tg-msg-bubble { background: #182533; border-radius: 4px 12px 12px 12px; padding: 7px 11px; font-size: 14px; line-height: 1.45; word-break: break-word; }
    .tg-msg-bubble strong { color: #fff; }
    .tg-msg-bubble code { background: #0e1621; padding: 1px 4px; border-radius: 3px; font-size: 12px; font-family: 'JetBrains Mono', monospace; }
    .tg-msg-bubble pre { background: #0e1621; padding: 8px; border-radius: 4px; overflow-x: auto; font-size: 12px; margin: 4px 0; font-family: 'JetBrains Mono', monospace; white-space: pre-wrap; }
    .tg-msg-time { font-size: 10px; color: #5b7083; text-align: right; margin-top: 1px; }
    @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* Sticky inline keyboard (bot menu) ‚Äî ALWAYS at bottom of messages area, above input */
    .tg-sticky-menu { flex-shrink: 0; background: #0e1621; border-top: 1px solid #1b2838; padding: 4px 8px 4px; }
    .tg-inline-row { display: flex; gap: 1px; margin-bottom: 1px; }
    .tg-inline-btn { flex: 1; background: #2b5278; border: none; border-radius: 4px; color: #fff; font-size: 12.5px; font-weight: 500; padding: 7px 2px; cursor: pointer; transition: background 0.12s; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tg-inline-btn:hover { background: #3a6da0; }
    .tg-inline-btn:active { background: #1d3f5e; transform: scale(0.97); }
    .tg-inline-btn.close-btn { background: transparent; color: #5b7083; font-size: 11px; }
    .tg-inline-btn.close-btn:hover { color: #ef5350; background: rgba(239, 83, 80, 0.08); }
    .tg-inline-btn.highlight { background: #4cc9f0; color: #000; }

    /* Chat input bar */
    .tg-input-bar { display: flex; align-items: center; gap: 8px; background: #17212b; border-top: 1px solid #1b2838; padding: 6px 10px; flex-shrink: 0; }
    .tg-input { flex: 1; background: #242f3d; border: none; border-radius: 18px; padding: 8px 14px; font-size: 14px; color: #e8edf2; outline: none; }
    .tg-input::placeholder { color: #5b7083; }
    .tg-input-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 4px; color: #5b7083; transition: color 0.15s; }
    .tg-input-btn:hover { color: #4cc9f0; }

    /* ‚îÄ‚îÄ MINIAPP VIEW ‚îÄ‚îÄ */
    .miniapp-view { position: absolute; inset: 0; display: flex; flex-direction: column; background: #0b0f14; transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s; transform: translateY(100%); opacity: 0; pointer-events: none; }
    .miniapp-view.active { transform: translateY(0); opacity: 1; pointer-events: auto; }

    /* MiniApp header (Telegram-style) */
    .miniapp-header { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #17212b; border-bottom: 1px solid #1b2838; flex-shrink: 0; z-index: 10; }
    .miniapp-back-btn { background: none; border: none; color: #4cc9f0; font-size: 22px; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.15s; display: flex; align-items: center; gap: 6px; font-weight: 600; }
    .miniapp-back-btn:hover { background: rgba(76, 201, 240, 0.1); }
    .miniapp-back-btn span { font-size: 14px; }
    .miniapp-header-title { flex: 1; font-size: 15px; font-weight: 600; color: #fff; text-align: center; }
    .miniapp-close-btn { background: none; border: none; color: #5b7083; font-size: 18px; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: color 0.15s; }
    .miniapp-close-btn:hover { color: #ef5350; }

    /* MiniApp content ‚Äî wraps #app, MUST allow scrolling */
    .miniapp-content { flex: 1; min-height: 0; overflow: hidden; position: relative; }
    .miniapp-content #app { position: absolute; inset: 0; display: flex; flex-direction: column; }

    /* Force dark theme */
    :root:not([data-theme="light"]) { color-scheme: dark; }
  </style>

  <!-- ‚ïê‚ïê‚ïê DEMO MOCK LAYER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       This script runs BEFORE the real app.js to mock:
       1. Telegram.WebApp ‚Äî provides fake theme, user, initData
       2. fetch() ‚Äî intercepts /api/* to return seed data
       3. WebSocket ‚Äî provides fake WS connection for live updates
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <script>
  (function() {
    'use strict';

    /* ‚îÄ‚îÄ Mock Telegram.WebApp ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const mockUser = {
      id: 1337420,
      first_name: 'Demo',
      last_name: 'User',
      username: 'demo_user',
      language_code: 'en',
      is_premium: true,
    };

    const theme = {
      bg_color: '#0b0f14',
      text_color: '#f1f5f9',
      hint_color: '#64748b',
      link_color: '#4cc9f0',
      button_color: '#4cc9f0',
      button_text_color: '#000000',
      secondary_bg_color: '#131a24',
      header_bg_color: '#0b0f14',
      accent_text_color: '#4cc9f0',
      section_bg_color: '#131a24',
      section_header_text_color: '#94a3b8',
      subtitle_text_color: '#94a3b8',
      destructive_text_color: '#ef4444',
      section_separator_color: '#1e293b',
      bottom_bar_bg_color: '#0b0f14',
    };

    window.Telegram = {
      WebApp: {
        initData: 'demo_mode=true&user=' + encodeURIComponent(JSON.stringify(mockUser)),
        initDataUnsafe: { user: mockUser, auth_date: Date.now() },
        version: '8.0',
        platform: 'web',
        colorScheme: 'dark',
        themeParams: theme,
        isExpanded: true,
        viewportHeight: window.innerHeight,
        viewportStableHeight: window.innerHeight,
        headerColor: theme.header_bg_color,
        backgroundColor: theme.bg_color,
        bottomBarColor: theme.bottom_bar_bg_color,
        isClosingConfirmationEnabled: false,
        isVerticalSwipesEnabled: false,
        isFullscreen: true,
        safeAreaInset: { top: 0, bottom: 0, left: 0, right: 0 },
        contentSafeAreaInset: { top: 0, bottom: 0, left: 0, right: 0 },
        BackButton: {
          isVisible: false,
          show() { this.isVisible = true; },
          hide() { this.isVisible = false; },
          onClick(cb) { this._cb = cb; },
          offClick() { this._cb = null; },
        },
        MainButton: {
          isVisible: false,
          text: '',
          color: theme.button_color,
          textColor: theme.button_text_color,
          isProgressVisible: false,
          show() { this.isVisible = true; },
          hide() { this.isVisible = false; },
          setText(t) { this.text = t; },
          onClick(cb) { this._cb = cb; },
          offClick() { this._cb = null; },
          showProgress() { this.isProgressVisible = true; },
          hideProgress() { this.isProgressVisible = false; },
          enable() {},
          disable() {},
        },
        HapticFeedback: {
          impactOccurred() {},
          notificationOccurred() {},
          selectionChanged() {},
        },
        ready() {},
        expand() {},
        close() {},
        requestFullscreen() {},
        disableVerticalSwipes() {},
        enableClosingConfirmation() {},
        setHeaderColor(c) { this.headerColor = c; },
        setBackgroundColor(c) { this.backgroundColor = c; },
        setBottomBarColor(c) { this.bottomBarColor = c; },
        onEvent(name, cb) {},
        offEvent(name, cb) {},
        showConfirm(msg, cb) { if (cb) cb(true); },
        showAlert(msg, cb) { if (cb) cb(); },
        showPopup(params, cb) { if (cb) cb('ok'); },
        openLink(url) { window.open(url, '_blank'); },
        openTelegramLink(url) {},
      },
    };

    /* ‚îÄ‚îÄ Seed Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const now = Date.now();
    const min = 60000;
    const hr = 3600000;

    const SEED_TASKS = [
      { id: 've-abc123', title: 'feat(market): add order expiry validation', status: 'done', priority: 'high', assignee: 'copilot-claude', branch: 've/abc123-market-order-expiry', pr: 187, created: now - 4*hr, updated: now - 1*hr },
      { id: 've-def456', title: 'fix(veid): token validation edge case', status: 'done', priority: 'medium', assignee: 'codex-default', branch: 've/def456-veid-token-fix', pr: 188, created: now - 3*hr, updated: now - 45*min },
      { id: 've-ghi789', title: 'refactor(escrow): batch settlement pipeline', status: 'inprogress', priority: 'high', assignee: 'copilot-claude', branch: 've/ghi789-escrow-batch', pr: 189, created: now - 2*hr, updated: now - 15*min },
      { id: 've-jkl012', title: 'feat(hpc): GPU resource metering', status: 'inprogress', priority: 'critical', assignee: 'codex-default', branch: 've/jkl012-hpc-gpu-metering', pr: null, created: now - 1*hr, updated: now - 5*min },
      { id: 've-mno345', title: 'docs: update provider integration guide', status: 'todo', priority: 'low', assignee: null, branch: null, pr: null, created: now - 30*min, updated: now - 30*min },
      { id: 've-pqr678', title: 'feat(provider): health check endpoint', status: 'todo', priority: 'medium', assignee: null, branch: null, pr: null, created: now - 20*min, updated: now - 20*min },
      { id: 've-stu901', title: 'fix(roles): permission cascade bug', status: 'draft', priority: 'high', assignee: null, branch: null, pr: null, created: now - 10*min, updated: now - 10*min },
      { id: 've-vwx234', title: 'test(mfa): add integration test suite', status: 'inreview', priority: 'medium', assignee: 'copilot-claude', branch: 've/vwx234-mfa-tests', pr: 190, created: now - 5*hr, updated: now - 30*min },
    ];

    const SEED_STATUS = {
      status: 'running',
      uptime: '2h 34m 12s',
      executorMode: 'internal',
      board: 'github',
      maxParallel: 6,
      version: '0.26.2',
      tasks: { completed: 13, failed: 1, retried: 2, active: 2, queued: 3 },
      prs: { created: 15, merged: 11, pending: 2, ciFailures: 1 },
    };

    const SEED_EXECUTORS = [
      { name: 'copilot-claude', sdk: 'copilot', model: 'claude-opus-4-6', weight: 50, status: 'active', load: 67, tasksCompleted: 8, avgTime: '12m', uptime: '2h 34m', session: 'sk-...7f3a' },
      { name: 'codex-default', sdk: 'codex', model: 'o4-mini', weight: 50, status: 'active', load: 42, tasksCompleted: 5, avgTime: '18m', uptime: '2h 34m', session: 'cx-...a91b' },
    ];

    const SEED_AGENTS = [
      {
        id: 'agent-001',
        name: 'copilot-claude',
        type: 'copilot',
        model: 'claude-opus-4-6',
        status: 'running',
        taskId: 've-ghi789',
        taskTitle: 'Escrow batch settlement pipeline',
        branch: 've/ghi789-escrow-batch',
        sessionId: 'ses-001',
        index: 0,
        startedAt: now - 80 * min,
        lastHeartbeat: now - 30000,
      },
      {
        id: 'agent-002',
        name: 'codex-default',
        type: 'codex',
        model: 'o4-mini',
        status: 'running',
        taskId: 've-jkl012',
        taskTitle: 'GPU resource metering',
        branch: 've/jkl012-hpc-gpu-metering',
        sessionId: 'ses-002',
        index: 1,
        startedAt: now - 52 * min,
        lastHeartbeat: now - 15000,
      },
      {
        id: 'agent-003',
        name: 'review-agent',
        type: 'codex',
        model: 'o4-mini',
        status: 'idle',
        taskId: 've-vwx234',
        taskTitle: 'Review MFA integration tests',
        branch: 've/vwx234-mfa-tests',
        sessionId: 'ses-003',
        index: 2,
        startedAt: now - 4 * hr,
        lastHeartbeat: now - 240000,
      },
    ];

    const SEED_LOGS = [
      { ts: now - 20*min, level: 'info', source: 'monitor', msg: 'Polling github for new tasks...' },
      { ts: now - 19*min, level: 'info', source: 'kanban', msg: 'Found 2 new tasks in backlog' },
      { ts: now - 18*min, level: 'info', source: 'task-executor', msg: 'Routing #42 feat(market): add order expiry ‚Üí copilot-claude' },
      { ts: now - 17*min, level: 'info', source: 'task-executor', msg: 'Routing #43 fix(veid): token validation ‚Üí codex-default' },
      { ts: now - 14*min, level: 'info', source: 'worktree', msg: 'Created ve/abc123-market-order-expiry' },
      { ts: now - 12*min, level: 'info', source: 'copilot', msg: 'Session started for #42' },
      { ts: now - 10*min, level: 'success', source: 'pr', msg: 'PR #187 created ‚Äî CI running...' },
      { ts: now - 8*min, level: 'success', source: 'ci', msg: 'PR #187 ‚Äî all checks passed' },
      { ts: now - 7*min, level: 'success', source: 'merge', msg: 'PR #187 merged to main ‚úì' },
      { ts: now - 5*min, level: 'info', source: 'health', msg: 'Health check: all systems nominal' },
      { ts: now - 2*min, level: 'info', source: 'review-agent', msg: 'Reviewing PR #189...' },
      { ts: now - 1*min, level: 'info', source: 'monitor', msg: 'Next poll in 60s...' },
    ];

    const SEED_HEALTH = {
      overall: 'healthy',
      components: [
        { name: 'GitHub API', status: 'ok', latency: '142ms' },
        { name: 'Telegram Bot', status: 'ok', latency: '89ms' },
        { name: 'Codex SDK', status: 'ok', latency: '234ms' },
        { name: 'Copilot SDK', status: 'ok', latency: '178ms' },
        { name: 'Shared State', status: 'ok', latency: '12ms' },
        { name: 'Worktree Manager', status: 'ok', latency: '45ms' },
      ],
    };

    const SEED_INFRA = {
      worktrees: [
        { branch: 've/abc123-market-order-expiry', path: '/worktrees/abc123', active: false },
        { branch: 've/ghi789-escrow-batch', path: '/worktrees/ghi789', active: true },
        { branch: 've/jkl012-hpc-gpu-metering', path: '/worktrees/jkl012', active: true },
        { branch: 've/vwx234-mfa-tests', path: '/worktrees/vwx234', active: true },
      ],
      containers: [],
      tunnelStatus: 'active',
      tunnelUrl: 'https://bosun-demo.trycloudflare.com',
    };

    const SEED_PROJECT = {
      name: 'virtengine',
      repo: 'virtengine/virtengine',
      defaultBranch: 'main',
      totalTasks: SEED_TASKS.length,
      completedTasks: 2,
      activePRs: 3,
    };

    const formatTimestamp = (ts) => new Date(ts).toISOString();
    let msgCounter = 0;
    function makeMsg(role, content, ts, type) {
      msgCounter += 1;
      const msg = {
        id: `msg-${msgCounter}`,
        role,
        content,
        timestamp: formatTimestamp(ts || Date.now()),
      };
      if (type) msg.type = type;
      return msg;
    }

    const SESSION_MESSAGES = {
      'ses-001': [
        makeMsg('system', 'Session started for ve-ghi789 (escrow batch settlement).', now - 2 * hr, 'system'),
        makeMsg('assistant', 'Mapping batch settlement flow and scanning keeper wiring.', now - 110 * min),
        makeMsg('assistant', 'Found stubs in `x/escrow/keeper/batch.go` and `msg_server.go`.', now - 95 * min),
        makeMsg('assistant', 'Drafted batch iterator and retry guard ‚Äî running tests next.', now - 70 * min),
        makeMsg('assistant', 'CI queued. Awaiting results.', now - 18 * min),
      ],
      'ses-002': [
        makeMsg('system', 'Session started for ve-jkl012 (GPU resource metering).', now - 1 * hr, 'system'),
        makeMsg('assistant', 'Reviewing resource meter hooks in `x/hpc`.', now - 52 * min),
        makeMsg('assistant', 'Adding metering sample + config toggle for GPU pods.', now - 28 * min),
        makeMsg('assistant', 'Drafted docs update for GPU metering flags.', now - 8 * min),
      ],
      'ses-003': [
        makeMsg('system', 'Review session: ve-vwx234 integration tests.', now - 4 * hr, 'system'),
        makeMsg('assistant', 'Two small nits: table-driven name clarity + lint import order.', now - 3 * hr),
        makeMsg('assistant', 'Approved after updates. Merged to main.', now - 2 * hr),
      ],
      'ses-004': [
        makeMsg('system', 'Provider health endpoint planning.', now - 90 * min, 'system'),
        makeMsg('assistant', 'Queued backlog items, waiting on API approval.', now - 60 * min),
      ],
      'ses-005': [
        makeMsg('system', 'Release checklist follow-up.', now - 6 * hr, 'system'),
        makeMsg('assistant', 'Release checklist completed. Archived for later.', now - 5 * hr),
      ],
    };

    const SEED_SESSIONS = [
      {
        id: 'ses-001',
        title: 'Escrow Batch Settlement',
        type: 'task',
        status: 'running',
        taskId: 've-ghi789',
        branch: 've/ghi789-escrow-batch',
        createdAt: now - 2 * hr,
        updatedAt: now - 12 * min,
        lastMessage: 'CI queued. Awaiting results.',
        messages: SESSION_MESSAGES['ses-001'],
      },
      {
        id: 'ses-002',
        title: 'GPU Metering Rollout',
        type: 'task',
        status: 'running',
        taskId: 've-jkl012',
        branch: 've/jkl012-hpc-gpu-metering',
        createdAt: now - 1 * hr,
        updatedAt: now - 6 * min,
        lastMessage: 'Drafted docs update for GPU metering flags.',
        messages: SESSION_MESSAGES['ses-002'],
      },
      {
        id: 'ses-003',
        title: 'PR Review: MFA Tests',
        type: 'review',
        status: 'completed',
        taskId: 've-vwx234',
        branch: 've/vwx234-mfa-tests',
        createdAt: now - 4 * hr,
        updatedAt: now - 2 * hr,
        lastMessage: 'Approved after updates. Merged to main.',
        messages: SESSION_MESSAGES['ses-003'],
      },
      {
        id: 'ses-004',
        title: 'Provider Health Endpoint',
        type: 'task',
        status: 'paused',
        taskId: 've-pqr678',
        branch: 've/pqr678-provider-health',
        createdAt: now - 90 * min,
        updatedAt: now - 60 * min,
        lastMessage: 'Queued backlog items, waiting on API approval.',
        messages: SESSION_MESSAGES['ses-004'],
      },
      {
        id: 'ses-005',
        title: 'Release Checklist',
        type: 'manual',
        status: 'archived',
        taskId: 've-rel001',
        branch: 've/release-checklist',
        createdAt: now - 6 * hr,
        updatedAt: now - 5 * hr,
        lastMessage: 'Release checklist completed. Archived for later.',
        messages: SESSION_MESSAGES['ses-005'],
      },
    ];

    const SESSION_DIFFS = {
      'ses-001': {
        files: [
          {
            filename: 'x/escrow/keeper/batch.go',
            status: 'added',
            additions: 42,
            deletions: 0,
            patch: [
              '@@ -0,0 +1,42 @@',
              '+package keeper',
              '+',
              '+// BatchSettle processes pending settlements in batch.',
              '+func (k Keeper) BatchSettle(ctx sdk.Context) error {',
              '+    iter := k.store.Iterator(ctx, k.settlementPrefix)',
              '+    defer iter.Close()',
              '+',
              '+    for ; iter.Valid(); iter.Next() {',
              '+        // settle',
              '+    }',
              '+    return nil',
              '+}',
            ].join('\n'),
          },
          {
            filename: 'x/escrow/keeper/msg_server.go',
            status: 'modified',
            additions: 9,
            deletions: 2,
            patch: [
              '@@ -118,6 +118,13 @@',
              ' func (s msgServer) TriggerSettlement(...) {',
              '+    if err := s.Keeper.BatchSettle(ctx); err != nil {',
              '+        return nil, err',
              '+    }',
              '     return &types.MsgTriggerSettlementResponse{}, nil',
              ' }',
            ].join('\n'),
          },
        ],
      },
      'ses-002': {
        files: [
          {
            filename: 'x/hpc/keeper/metering.go',
            status: 'modified',
            additions: 18,
            deletions: 4,
            patch: [
              '@@ -44,8 +44,22 @@',
              '-func (k Keeper) TrackCPU(...) {',
              '+func (k Keeper) TrackGPU(ctx sdk.Context, pod Pod) error {',
              '+    if !k.cfg.GPUMeteringEnabled {',
              '+        return nil',
              '+    }',
              '+    // ... record usage',
              '+    return nil',
              '+}',
            ].join('\n'),
          },
          {
            filename: 'docs/hpc/gpu-metering.md',
            status: 'added',
            additions: 26,
            deletions: 0,
            patch: [
              '@@ -0,0 +1,26 @@',
              '+# GPU Metering',
              '+',
              '+Enable with `HPC_GPU_METERING=true` in bosun config.',
              '+',
              '+Usage is tracked per workload minute.',
            ].join('\n'),
          },
        ],
      },
      'ses-003': {
        files: [
          {
            filename: 'tests/mfa/integration.test.ts',
            status: 'modified',
            additions: 5,
            deletions: 2,
            patch: [
              '@@ -88,7 +88,10 @@',
              '-describe("MFA integration", () => {',
              '+describe("MFA integration flow", () => {',
              '   it("rejects invalid token", async () => {',
              '     ...',
              '   });',
              ' });',
            ].join('\n'),
          },
        ],
      },
      'ses-004': { files: [] },
      'ses-005': { files: [] },
    };

    /* ‚îÄ‚îÄ Internal State (mutable ‚Äî actions modify this in-place) ‚îÄ‚îÄ‚îÄ‚îÄ */
    const STATE = {
      tasks: SEED_TASKS,
      status: SEED_STATUS,
      executors: SEED_EXECUTORS,
      agents: SEED_AGENTS,
      logs: SEED_LOGS,
      health: SEED_HEALTH,
      infra: SEED_INFRA,
      project: SEED_PROJECT,
      paused: false,
      maxParallel: 6,
      settings: {
        maxParallel: 6,
        executorMode: 'internal',
        autoMerge: true,
        autoRebase: true,
        reviewAgent: true,
        sentinelEnabled: false,
        sdk: 'auto',
        region: 'auto',
      },
      sessions: SEED_SESSIONS,
      sessionDiffs: SESSION_DIFFS,
      worktrees: [
        { branch: 've/abc123-market-order-expiry', path: '/worktrees/abc123', active: false, taskId: 've-abc123' },
        { branch: 've/ghi789-escrow-batch', path: '/worktrees/ghi789', active: true, taskId: 've-ghi789' },
        { branch: 've/jkl012-hpc-gpu-metering', path: '/worktrees/jkl012', active: true, taskId: 've-jkl012' },
        { branch: 've/vwx234-mfa-tests', path: '/worktrees/vwx234', active: true, taskId: 've-vwx234' },
      ],
      sharedWorkspaces: [
        { id: 'sw-1', name: 'shared-escrow-dev', claimedBy: 'copilot-claude', claimedAt: now - 1*hr, expiresAt: now + 1*hr },
      ],
      gitBranches: ['main', 've/abc123-market-order-expiry', 've/ghi789-escrow-batch', 've/jkl012-hpc-gpu-metering', 've/vwx234-mfa-tests'],
      gitDiff: '--- a/x/escrow/keeper/batch.go\n+++ b/x/escrow/keeper/batch.go\n@@ -0,0 +1,42 @@\n+package keeper\n+\n+// BatchSettle processes pending settlements in batch.\n+func (k Keeper) BatchSettle(ctx sdk.Context) error {\n+    // ... implementation\n+    return nil\n+}',
      agentLogFiles: ['copilot-claude-42.log', 'codex-default-43.log', 'monitor.log'],
      presence: {
        instances: [{ id: 'inst-1', host: 'dev-machine', pid: 12345, started: now - 3*hr, role: 'primary' }],
        coordinator: { id: 'inst-1', host: 'dev-machine', elected: now - 3*hr },
      },
    };

    /* ‚îÄ‚îÄ Helper: find task by ID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function findTask(id) { return STATE.tasks.find(t => t.id === id); }
    function addLog(level, source, msg) {
      STATE.logs.unshift({ ts: Date.now(), level, source, msg });
      if (STATE.logs.length > 100) STATE.logs.length = 100;
    }
    function formatLogLine(entry) {
      return `[${formatTimestamp(entry.ts)}] [${entry.level}] ${entry.source}: ${entry.msg}`;
    }

    let replyCursor = 0;
    const RESPONSE_SETS = [
      [
        { type: 'tool_call', content: 'rg "BatchSettle" x/escrow -n' },
        { type: 'tool_result', content: 'x/escrow/keeper/batch.go:12 BatchSettle\nx/escrow/types/msgs.go:87 MsgTriggerSettlement' },
        { role: 'assistant', content: 'I found a stubbed `BatchSettle` entry point. I can wire the iterator and add a guard in the msg server. Want me to push the patch?' },
      ],
      [
        { type: 'tool_call', content: 'rg "GPU" x/hpc -n' },
        { type: 'tool_result', content: 'x/hpc/keeper/metering.go:44 TrackGPU\nx/hpc/types/config.go:18 GPUMeteringEnabled' },
        { role: 'assistant', content: 'GPU metering hooks are already scaffolded. I can add the config toggle + emit usage events, plus a short docs note.' },
      ],
      [
        { type: 'tool_call', content: 'git status --short' },
        { type: 'tool_result', content: ' M tests/mfa/integration.test.ts\n M docs/mfa/README.md' },
        { role: 'assistant', content: 'Updated the MFA test names and added a short docs note. Ready for review.' },
      ],
    ];

    function appendMessage(session, msg) {
      session.messages.push(msg);
      session.updatedAt = Date.now();
      if (msg.content && msg.role !== 'system' && msg.type !== 'tool_call' && msg.type !== 'tool_result') {
        session.lastMessage = msg.content;
      }
    }

    function scheduleResponses(session) {
      const set = RESPONSE_SETS[replyCursor % RESPONSE_SETS.length];
      replyCursor += 1;
      let delay = 600 + Math.random() * 600;
      set.forEach((item) => {
        const msg = makeMsg(
          item.role || 'assistant',
          item.content,
          Date.now() + delay,
          item.type,
        );
        const weight = Math.min(2200, Math.max(700, item.content.length * 18));
        delay += weight + Math.random() * 500;
        setTimeout(() => {
          appendMessage(session, msg);
          addLog('info', 'agent', `${session.title}: ${item.type ? item.type.replace('_', ' ') : 'message'} queued`);
        }, delay);
      });
    }

    /* ‚îÄ‚îÄ API Route Handler (comprehensive ‚Äî catches ALL /api/* calls) */
    function handleApi(path, method, body) {
      // Normalize: strip query string for route matching
      const [route, qs] = path.split('?');
      const params = new URLSearchParams(qs || '');

      // ‚îÄ‚îÄ Status & Executor ‚îÄ‚îÄ
      if (route === '/api/status')
        return { data: STATE.status };
      if (route === '/api/executor')
        return { data: { ...STATE.status, maxParallel: STATE.maxParallel, paused: STATE.paused, executors: STATE.executors } };
      if (route === '/api/executor/pause') {
        STATE.paused = true; addLog('info', 'executor', 'Executor paused');
        return { ok: true, paused: true };
      }
      if (route === '/api/executor/resume') {
        STATE.paused = false; addLog('info', 'executor', 'Executor resumed');
        return { ok: true, paused: false };
      }
      if (route === '/api/executor/maxparallel') {
        const mp = body?.maxParallel ?? STATE.maxParallel;
        STATE.maxParallel = mp; STATE.status.maxParallel = mp;
        addLog('info', 'executor', `Max parallel set to ${mp}`);
        return { ok: true, maxParallel: mp };
      }
      if (route === '/api/executor/stop-slot') {
        addLog('info', 'executor', `Slot stopped: ${body?.slotId || 'unknown'}`);
        return { ok: true };
      }
      if (route === '/api/executor/dispatch') {
        addLog('info', 'executor', `Manual dispatch: ${body?.taskId || 'unknown'}`);
        return { ok: true, dispatched: body?.taskId };
      }

      // ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ
      if (route === '/api/tasks') {
        let tasks = [...STATE.tasks];
        const status = params.get('status');
        const priority = params.get('priority');
        const search = params.get('search');
        const sort = params.get('sort');
        if (status && status !== 'all') tasks = tasks.filter(t => t.status === status);
        if (priority && priority !== 'all') tasks = tasks.filter(t => t.priority === priority);
        if (search) tasks = tasks.filter(t => t.title.toLowerCase().includes(search.toLowerCase()));
        if (sort === 'priority') tasks.sort((a, b) => { const o = {critical:0,high:1,medium:2,low:3}; return (o[a.priority]??9)-(o[b.priority]??9); });
        if (sort === '-updated') tasks.sort((a, b) => b.updated - a.updated);
        const page = parseInt(params.get('page')) || 1;
        const pageSize = parseInt(params.get('pageSize') || params.get('limit')) || 50;
        const total = tasks.length;
        const paged = tasks.slice((page-1)*pageSize, page*pageSize);
        return { data: paged, tasks: paged, total, totalPages: Math.max(1, Math.ceil(total/pageSize)), page, pageSize };
      }
      if (route === '/api/tasks/detail') {
        const t = findTask(params.get('taskId'));
        return { data: t || null };
      }
      if (route === '/api/tasks/create') {
        const id = 've-' + Math.random().toString(36).slice(2, 8);
        const t = { id, title: body?.title || 'New task', status: 'todo', priority: body?.priority || 'medium', assignee: null, branch: null, pr: null, created: Date.now(), updated: Date.now() };
        STATE.tasks.unshift(t); addLog('success', 'kanban', `Task created: ${t.title}`);
        return { ok: true, data: t };
      }
      if (route === '/api/tasks/update') {
        const t = findTask(body?.taskId || body?.id);
        if (t) { Object.assign(t, body, { updated: Date.now() }); addLog('info', 'kanban', `Task updated: ${t.title}`); }
        return { ok: true, data: t || null };
      }
      if (route === '/api/tasks/edit') {
        const t = findTask(body?.taskId || body?.id);
        if (t) { if (body?.title) t.title = body.title; if (body?.priority) t.priority = body.priority; t.updated = Date.now(); }
        return { ok: true, data: t || null };
      }
      if (route === '/api/tasks/start') {
        const t = findTask(body?.taskId);
        if (t) { t.status = 'inprogress'; t.updated = Date.now(); addLog('info', 'task-executor', `Task started: ${t.title}`); }
        return { ok: true, data: t || null };
      }
      if (route === '/api/tasks/retry') {
        const t = findTask(body?.taskId);
        if (t) { t.status = 'todo'; t.updated = Date.now(); addLog('info', 'task-executor', `Task retried: ${t.title}`); }
        return { ok: true, data: t || null };
      }

      // ‚îÄ‚îÄ Agents ‚îÄ‚îÄ
      if (route === '/api/agents')
        return { data: STATE.agents };
      if (route === '/api/executors')
        return { executors: STATE.executors };

      // ‚îÄ‚îÄ Logs ‚îÄ‚îÄ
      if (route === '/api/logs') {
        const lines = parseInt(params.get('lines')) || 50;
        const entries = STATE.logs.slice(0, lines);
        return { data: { lines: entries.map(formatLogLine) }, lines: entries.map(formatLogLine) };
      }
      if (route === '/api/agent-logs')
        return { data: STATE.agentLogFiles };
      if (route === '/api/agent-logs/tail') {
        const file = params.get('file') || params.get('query') || '';
        const n = parseInt(params.get('lines')) || 100;
        const lines = Array.from({ length: Math.min(n, 20) }, (_, i) => {
          const ts = new Date(now - (20 - i) * 30000).toISOString();
          return `[${ts}] [info] Demo log line ${i + 1} from ${file || 'agent'}`;
        });
        return { data: { lines } };
      }
      if (route === '/api/agent-context') {
        const q = params.get('query') || '';
        return { data: { query: q, branch: q, files: ['keeper.go', 'types.go', 'msg_server.go'], recentCommits: ['feat: initial implementation', 'fix: lint errors'], worktree: '/worktrees/' + q.slice(0, 6) } };
      }

      // ‚îÄ‚îÄ Health ‚îÄ‚îÄ
      if (route === '/api/health')
        return STATE.health;

      // ‚îÄ‚îÄ Infrastructure ‚îÄ‚îÄ
      if (route === '/api/infra')
        return { data: STATE.infra };
      if (route === '/api/worktrees') {
        if (route === '/api/worktrees') return { data: STATE.worktrees, stats: { total: STATE.worktrees.length, active: STATE.worktrees.filter(w => w.active).length } };
      }
      if (route === '/api/worktrees/prune') {
        STATE.worktrees = STATE.worktrees.filter(w => w.active); addLog('info', 'worktree', 'Pruned inactive worktrees');
        return { ok: true, pruned: 1 };
      }
      if (route === '/api/worktrees/release') {
        const branch = body?.branch;
        const wt = STATE.worktrees.find(w => w.branch === branch);
        if (wt) wt.active = false;
        return { ok: true };
      }

      // ‚îÄ‚îÄ Shared Workspaces ‚îÄ‚îÄ
      if (route === '/api/shared-workspaces')
        return { data: STATE.sharedWorkspaces };
      if (route === '/api/shared-workspaces/claim') {
        const ws = { id: 'sw-' + Math.random().toString(36).slice(2, 5), name: body?.name || 'workspace', claimedBy: body?.agent || 'demo', claimedAt: Date.now(), expiresAt: Date.now() + 2*hr };
        STATE.sharedWorkspaces.push(ws);
        return { ok: true, data: ws };
      }
      if (route === '/api/shared-workspaces/renew') {
        const ws = STATE.sharedWorkspaces.find(w => w.id === body?.id);
        if (ws) ws.expiresAt = Date.now() + 2*hr;
        return { ok: true };
      }
      if (route === '/api/shared-workspaces/release') {
        STATE.sharedWorkspaces = STATE.sharedWorkspaces.filter(w => w.id !== body?.id);
        return { ok: true };
      }

      // ‚îÄ‚îÄ Git ‚îÄ‚îÄ
      if (route === '/api/git/branches')
        return { data: STATE.gitBranches };
      if (route === '/api/git/diff')
        return { data: STATE.gitDiff };

      // ‚îÄ‚îÄ Sessions ‚îÄ‚îÄ
      if (route === '/api/sessions' && method === 'GET') {
        return {
          sessions: STATE.sessions.map((s) => ({
            id: s.id,
            title: s.title,
            type: s.type,
            status: s.status,
            taskId: s.taskId,
            branch: s.branch,
            createdAt: s.createdAt,
            updatedAt: s.updatedAt,
            lastMessage: s.lastMessage,
          })),
        };
      }
      if (route.match(/^\/api\/sessions\/[^/]+\/diff$/)) {
        const sid = route.split('/')[3];
        return { diff: STATE.sessionDiffs[sid] || { files: [] } };
      }
      if (route.match(/^\/api\/sessions\/[^/]+\/message$/)) {
        const sid = route.split('/')[3];
        const ses = STATE.sessions.find(s => s.id === sid);
        const content = String(body?.content || body?.text || body?.message || '');
        if (ses && content) {
          appendMessage(ses, makeMsg('user', content, Date.now()));
          ses.status = ses.status === 'archived' ? 'active' : ses.status;
          scheduleResponses(ses);
        }
        return { ok: true, session: ses || null };
      }
      if (route.match(/^\/api\/sessions\/[^/]+\/resume$/)) {
        const sid = route.split('/')[3];
        const ses = STATE.sessions.find(s => s.id === sid);
        if (ses) ses.status = 'active';
        return { ok: true, session: ses || null };
      }
      if (route.match(/^\/api\/sessions\/[^/]+\/archive$/)) {
        const sid = route.split('/')[3];
        const ses = STATE.sessions.find(s => s.id === sid);
        if (ses) ses.status = 'archived';
        return { ok: true, session: ses || null };
      }
      if (route === '/api/sessions/create') {
        const id = 'ses-' + Math.random().toString(36).slice(2, 6);
        const s = {
          id,
          title: body?.title || 'New Session',
          type: body?.type || 'manual',
          status: 'active',
          taskId: body?.taskId || null,
          branch: body?.branch || null,
          createdAt: Date.now(),
          updatedAt: Date.now(),
          lastMessage: 'Session created.',
          messages: [
            makeMsg('system', 'Session initialized in demo mode.', Date.now(), 'system'),
          ],
        };
        STATE.sessions.unshift(s);
        STATE.sessionDiffs[id] = { files: [] };
        return { ok: true, session: s };
      }
      if (route.match(/^\/api\/sessions\/[^/]+$/) && method === 'GET') {
        const sid = route.split('/')[3];
        const ses = STATE.sessions.find(s => s.id === sid) || null;
        return { session: ses };
      }

      // ‚îÄ‚îÄ Settings & Config ‚îÄ‚îÄ
      if (route === '/api/settings')
        return STATE.settings;
      if (route === '/api/config/update') {
        Object.assign(STATE.settings, body || {});
        return { ok: true };
      }

      // ‚îÄ‚îÄ Command ‚îÄ‚îÄ
      if (route === '/api/command') {
        const cmd = body?.command || '';
        addLog('info', 'command', `Executed: ${cmd}`);
        return { ok: true, command: cmd, response: 'Command executed in demo mode: ' + cmd };
      }

      // ‚îÄ‚îÄ Presence ‚îÄ‚îÄ
      if (route === '/api/presence')
        return { data: STATE.presence };

      // ‚îÄ‚îÄ Project ‚îÄ‚îÄ
      if (route === '/api/project' || route === '/api/project-summary')
        return { data: STATE.project };

      // ‚îÄ‚îÄ Catch-all: return empty success for any unhandled /api/ route ‚îÄ‚îÄ
      console.debug('[demo] Unhandled API route:', method, path);
      return { ok: true, data: null };
    }

    /* ‚îÄ‚îÄ Intercept fetch() ‚Äî ALL /api/ calls handled internally ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const _realFetch = window.fetch;
    window.fetch = function(url, options) {
      const path = typeof url === 'string' ? url : url?.url || '';

      // Intercept ALL /api/ calls ‚Äî nothing reaches the network
      if (path.startsWith('/api/') || path.startsWith('/api?')) {
        let body = null;
        if (options?.body) {
          try { body = JSON.parse(options.body); } catch {}
        }
        const method = (options?.method || 'GET').toUpperCase();
        const data = handleApi(path, method, body);
        return Promise.resolve(new Response(JSON.stringify(data), {
          status: 200,
          headers: { 'Content-Type': 'application/json' },
        }));
      }

      // Pass through non-API requests (fonts, CDN, ES modules, etc.)
      return _realFetch.apply(this, arguments);
    };

    /* ‚îÄ‚îÄ Intercept WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const _RealWS = window.WebSocket;
    window.WebSocket = function(url, protocols) {
      const fake = {
        url: url,
        readyState: 1, // OPEN
        bufferedAmount: 0,
        extensions: '',
        protocol: '',
        onopen: null,
        onmessage: null,
        onclose: null,
        onerror: null,
        send(data) { /* swallow */ },
        close() {
          this.readyState = 3;
          if (this.onclose) this.onclose({ code: 1000, reason: 'Demo mode' });
        },
        addEventListener(type, handler) {
          this['on' + type] = handler;
        },
        removeEventListener() {},
      };

      // Simulate open after microtask
      setTimeout(() => {
        fake.readyState = 1;
        if (fake.onopen) fake.onopen({});

        // Send pong responses
        setInterval(() => {
          if (fake.onmessage) {
            fake.onmessage({ data: JSON.stringify({ type: 'pong', ts: Date.now() }) });
          }
        }, 5000);

        // Simulate periodic task updates
        let updateIdx = 0;
        setInterval(() => {
          if (!fake.onmessage) return;
          const updates = [
            { type: 'task-update', task: { id: 've-ghi789', status: 'inprogress' } },
            { type: 'log', entry: { ts: Date.now(), level: 'info', source: 'monitor', msg: 'Health check passed ‚Äî all systems nominal' } },
            { type: 'executor-update', executor: { name: 'copilot-claude', load: 55 + Math.floor(Math.random() * 25) } },
          ];
          fake.onmessage({ data: JSON.stringify(updates[updateIdx % updates.length]) });
          updateIdx++;
        }, 8000);
      }, 100);

      return fake;
    };
    window.WebSocket.CONNECTING = 0;
    window.WebSocket.OPEN = 1;
    window.WebSocket.CLOSING = 2;
    window.WebSocket.CLOSED = 3;

  })();
  </script>
</head>
<body>
  <!-- Demo mode banner (always on top) -->
  <div class="demo-banner">‚ö° Bosun Demo Mode ‚Äî Seed Data</div>

  <!-- ‚ïê‚ïê‚ïê Two-View Container ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       View A: Telegram Chat (default) ‚Äî chat messages + sticky bot menu
       View B: MiniApp (overlay) ‚Äî opened from "Open Control Center"
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="demo-views">

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ VIEW A: TELEGRAM CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="tg-view" id="tg-view">
      <!-- Chat header -->
      <div class="tg-header">
        <div class="tg-header-avatar">ü§ñ</div>
        <div class="tg-header-info">
          <div class="tg-header-name">Bosun Bot</div>
          <div class="tg-header-status">online</div>
        </div>
      </div>

      <!-- Chat messages (scrollable) -->
      <div class="tg-messages" id="tg-messages">
        <div class="tg-messages-spacer"></div>
        <!-- Initial welcome message -->
        <div class="tg-msg">
          <div class="tg-msg-name">Bosun Bot</div>
          <div class="tg-msg-bubble">
            <strong>ü§ñ Bosun Control Center</strong><br/>
            Pick a section below to manage your automation pipeline.<br/><br/>
            <strong>Status:</strong> Executor running ‚Ä¢ Slots 2/4<br/>
            <strong>Tasks:</strong> 8 total ‚Ä¢ 2 running ‚Ä¢ 3 queued
          </div>
          <div class="tg-msg-time" id="tg-init-time"></div>
        </div>
      </div>

      <!-- Sticky bot menu (inline keyboard) ‚Äî ALWAYS visible above input -->
      <div class="tg-sticky-menu" id="tg-sticky-menu">
        <div class="tg-inline-row">
          <button class="tg-inline-btn highlight" data-cmd="miniapp">üì± Open Control Center</button>
        </div>
        <div class="tg-inline-row">
          <button class="tg-inline-btn" data-cmd="overview">üìä Overview</button>
          <button class="tg-inline-btn" data-cmd="tasks">üß≠ Tasks</button>
          <button class="tg-inline-btn" data-cmd="agents">ü§ñ Agents</button>
        </div>
        <div class="tg-inline-row">
          <button class="tg-inline-btn" data-cmd="executor">‚öôÔ∏è Executor</button>
          <button class="tg-inline-btn" data-cmd="workspaces">üå≥ Workspaces</button>
          <button class="tg-inline-btn" data-cmd="routing">üõ∞ Routing</button>
        </div>
        <div class="tg-inline-row">
          <button class="tg-inline-btn" data-cmd="logs">üìÅ Logs & Git</button>
          <button class="tg-inline-btn" data-cmd="integrations">üîå Integrations</button>
          <button class="tg-inline-btn" data-cmd="session">üß† Session</button>
        </div>
        <div class="tg-inline-row">
          <button class="tg-inline-btn" data-cmd="ask">üí¨ Ask Agent</button>
          <button class="tg-inline-btn" data-cmd="commands">üìñ All Commands</button>
        </div>
        <div class="tg-inline-row">
          <button class="tg-inline-btn" data-cmd="refresh">üîÑ Refresh</button>
          <button class="tg-inline-btn close-btn" data-cmd="close">‚úñ Close Menu</button>
        </div>
      </div>

      <!-- Chat input bar -->
      <div class="tg-input-bar">
        <button class="tg-input-btn" id="tg-menu-toggle" title="Toggle Bot Menu">‚ò∞</button>
        <input class="tg-input" id="tg-chat-input" placeholder="Message Bosun Bot..." />
        <button class="tg-input-btn" id="tg-send-btn" title="Send">‚û§</button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ VIEW B: MINIAPP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="miniapp-view" id="miniapp-view">
      <!-- MiniApp header (Telegram-style with back button) -->
      <div class="miniapp-header">
        <button class="miniapp-back-btn" id="miniapp-back" title="Back to Chat">
          ‚Üê <span>Bosun</span>
        </button>
        <div class="miniapp-header-title">Control Center</div>
        <button class="miniapp-close-btn" id="miniapp-close" title="Close">‚úï</button>
      </div>

      <!-- MiniApp content (wraps #app) -->
      <div class="miniapp-content">
        <div id="app">
          <div id="boot-loader" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-family:'Inter',sans-serif;color:#9aa3b8;background:#0b0f14;overflow:hidden">
            <style>
              .boot-ring{position:absolute;inset:0;border-radius:50%;border:2px solid rgba(76,201,240,.15);animation:boot-spin 3s linear infinite}
              .boot-ring-inner{position:absolute;inset:8px;border-radius:50%;border:2px solid transparent;border-top-color:#4cc9f0;border-right-color:rgba(76,201,240,.4);animation:boot-spin 1.5s linear infinite reverse}
              .boot-dot{position:absolute;top:50%;left:50%;width:16px;height:16px;margin:-8px 0 0 -8px;border-radius:50%;background:linear-gradient(135deg,#4cc9f0,#60cc5d);box-shadow:0 0 20px rgba(76,201,240,.5);animation:boot-pulse 2s ease-in-out infinite}
              @keyframes boot-spin{to{transform:rotate(360deg)}}
              @keyframes boot-pulse{0%,100%{transform:scale(1);opacity:.8}50%{transform:scale(1.2);opacity:1}}
            </style>
            <div style="position:relative;width:60px;height:60px;margin-bottom:16px">
              <div class="boot-ring"></div>
              <div class="boot-ring-inner"></div>
              <div class="boot-dot"></div>
            </div>
            <div style="font-size:13px;color:#64748b">Loading Control Center...</div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /.demo-views -->

  <!-- ‚ïê‚ïê‚ïê CHAT INTERACTION ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <script>
  (function() {
    'use strict';

    const tgView     = document.getElementById('tg-view');
    const miniView   = document.getElementById('miniapp-view');
    const msgArea    = document.getElementById('tg-messages');
    const stickyMenu = document.getElementById('tg-sticky-menu');
    const inputField = document.getElementById('tg-chat-input');
    const sendBtn    = document.getElementById('tg-send-btn');
    const menuToggle = document.getElementById('tg-menu-toggle');
    const backBtn    = document.getElementById('miniapp-back');
    const closeBtn   = document.getElementById('miniapp-close');

    let menuVisible = true;
    let miniAppLoaded = false;

    // ‚îÄ‚îÄ Time helpers ‚îÄ‚îÄ
    function nowTime() {
      const d = new Date();
      return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
    }
    // Set initial message time
    const initTime = document.getElementById('tg-init-time');
    if (initTime) initTime.textContent = nowTime();

    // ‚îÄ‚îÄ Add a bot message to the chat ‚îÄ‚îÄ
    function addBotMessage(html) {
      const msg = document.createElement('div');
      msg.className = 'tg-msg';
      msg.innerHTML = `
        <div class="tg-msg-name">Bosun Bot</div>
        <div class="tg-msg-bubble">${html}</div>
        <div class="tg-msg-time">${nowTime()}</div>
      `;
      msgArea.appendChild(msg);
      // Scroll to bottom
      requestAnimationFrame(() => { msgArea.scrollTop = msgArea.scrollHeight; });
    }

    // ‚îÄ‚îÄ Add a user message to the chat ‚îÄ‚îÄ
    function addUserMessage(text) {
      const msg = document.createElement('div');
      msg.className = 'tg-msg';
      msg.style.cssText = 'align-self:flex-end;';
      msg.innerHTML = `
        <div class="tg-msg-bubble" style="background:#2b5278;border-radius:12px 4px 12px 12px;">${text}</div>
        <div class="tg-msg-time">${nowTime()}</div>
      `;
      msgArea.appendChild(msg);
      requestAnimationFrame(() => { msgArea.scrollTop = msgArea.scrollHeight; });
    }

    // ‚îÄ‚îÄ COMMAND RESPONSE GENERATORS ‚îÄ‚îÄ
    // These produce HTML responses for each menu button, using the seed data from the mock layer

    function cmdOverview() {
      return `<strong>üìä System Overview</strong><br/><br/>` +
        `<strong>Executor:</strong> running<br/>` +
        `<strong>Slots:</strong> 2 / 4 active<br/>` +
        `<strong>Tasks:</strong> 8 total ‚Äî 2 running, 3 queued, 1 done, 1 failed, 1 cancelled<br/>` +
        `<strong>Agents:</strong> 3 configured (copilot-claude, codex-mini, local-gpt4)<br/>` +
        `<strong>Health:</strong> ‚úÖ All systems nominal<br/>` +
        `<strong>Uptime:</strong> 4h 23m`;
    }

    function cmdTasks() {
      // Use global SEED_TASKS if available
      const tasks = window.SEED_TASKS || [];
      if (!tasks.length) return '<strong>üß≠ Tasks</strong><br/><br/>No tasks found.';
      let html = '<strong>üß≠ Task Queue</strong><br/><br/>';
      const icons = { running: 'üîµ', queued: '‚è≥', done: '‚úÖ', failed: '‚ùå', cancelled: '‚ö™' };
      tasks.forEach(t => {
        html += `${icons[t.status] || '¬∑'} <strong>${t.title}</strong> ‚Äî <code>${t.status}</code><br/>`;
      });
      return html;
    }

    function cmdAgents() {
      const agents = window.SEED_AGENTS || [];
      if (!agents.length) return '<strong>ü§ñ Agents</strong><br/><br/>No agents configured.';
      let html = '<strong>ü§ñ Agents</strong><br/><br/>';
      agents.forEach(a => {
        const status = a.healthy === false ? 'üî¥' : 'üü¢';
        html += `${status} <strong>${a.name}</strong> ‚Äî ${a.provider || 'unknown'} ¬∑ model: <code>${a.model || '?'}</code><br/>`;
      });
      return html;
    }

    function cmdExecutor() {
      return `<strong>‚öôÔ∏è Executor Status</strong><br/><br/>` +
        `<strong>State:</strong> üü¢ running<br/>` +
        `<strong>Concurrency:</strong> 4 slots<br/>` +
        `<strong>Active:</strong> 2 tasks executing<br/>` +
        `<strong>Queued:</strong> 3 tasks waiting<br/>` +
        `<strong>Paused:</strong> No<br/><br/>` +
        `Commands:<br/>` +
        `<code>/pause</code> ‚Äî Pause executor<br/>` +
        `<code>/resume</code> ‚Äî Resume executor<br/>` +
        `<code>/run &lt;task&gt;</code> ‚Äî Force-dispatch a task`;
    }

    function cmdWorkspaces() {
      const infra = window.SEED_INFRA || {};
      const wt = infra.worktrees || [];
      if (!wt.length) return '<strong>üå≥ Workspaces</strong><br/><br/>No worktrees found.';
      let html = '<strong>üå≥ Worktrees / Workspaces</strong><br/><br/>';
      wt.forEach(w => {
        html += `üìÅ <strong>${w.branch || w.path}</strong> ‚Äî ${w.path}<br/>`;
      });
      return html;
    }

    function cmdRouting() {
      return `<strong>üõ∞ Agent Routing</strong><br/><br/>` +
        `<strong>Strategy:</strong> round-robin with fallback<br/>` +
        `<strong>Primary:</strong> copilot-claude (healthy ‚úÖ)<br/>` +
        `<strong>Fallback:</strong> codex-mini (healthy ‚úÖ)<br/>` +
        `<strong>Local:</strong> local-gpt4 (offline üî¥)<br/><br/>` +
        `Tasks are routed to the primary agent first. If it fails or times out, fallback engages automatically.`;
    }

    function cmdLogs() {
      const logs = window.SEED_LOGS || [];
      if (!logs.length) return '<strong>üìÅ Logs</strong><br/><br/>No recent logs.';
      let html = '<strong>üìÅ Recent Logs</strong><br/><br/><pre>';
      logs.slice(-8).forEach(l => {
        const lvl = (l.level || 'info').toUpperCase().padEnd(5);
        const src = (l.source || '?').padEnd(10);
        html += `[${lvl}] ${src} ${l.msg}\n`;
      });
      html += '</pre>';
      return html;
    }

    function cmdIntegrations() {
      return `<strong>üîå Integrations</strong><br/><br/>` +
        `‚úÖ <strong>GitHub</strong> ‚Äî Connected (virtengine-gh)<br/>` +
        `‚úÖ <strong>Telegram</strong> ‚Äî Bot active (this chat)<br/>` +
        `‚úÖ <strong>VS Code</strong> ‚Äî Copilot extension linked<br/>` +
        `‚¨ö <strong>Slack</strong> ‚Äî Not configured<br/>` +
        `‚¨ö <strong>Discord</strong> ‚Äî Not configured<br/><br/>` +
        `Use <code>/integrations setup &lt;name&gt;</code> to configure.`;
    }

    function cmdSession() {
      const sessions = window.SEED_SESSIONS || [];
      if (!sessions.length) return '<strong>üß† Sessions</strong><br/><br/>No active sessions.';
      let html = '<strong>üß† Active Sessions</strong><br/><br/>';
      sessions.forEach(s => {
        const icon = s.status === 'active' ? 'üü¢' : s.status === 'completed' ? '‚úÖ' : 'üî¥';
        html += `${icon} <strong>${s.title || s.id}</strong> ‚Äî ${s.agent || '?'} ¬∑ ${s.status}<br/>`;
      });
      return html;
    }

    function cmdAsk() {
      return `<strong>üí¨ Ask Agent</strong><br/><br/>` +
        `Type your question in the input box below and press Send.<br/><br/>` +
        `The active agent (<strong>copilot-claude</strong>) will respond.<br/><br/>` +
        `<em>Tip: Prefix with <code>/ask</code> for explicit agent routing.</em>`;
    }

    function cmdCommands() {
      return `<strong>üìñ All Commands</strong><br/><br/>` +
        `<code>/status</code> ‚Äî System overview<br/>` +
        `<code>/tasks</code> ‚Äî List task queue<br/>` +
        `<code>/agents</code> ‚Äî List configured agents<br/>` +
        `<code>/logs</code> ‚Äî Recent log entries<br/>` +
        `<code>/pause</code> ‚Äî Pause executor<br/>` +
        `<code>/resume</code> ‚Äî Resume executor<br/>` +
        `<code>/run &lt;id&gt;</code> ‚Äî Force-dispatch a task<br/>` +
        `<code>/cancel &lt;id&gt;</code> ‚Äî Cancel a running task<br/>` +
        `<code>/sessions</code> ‚Äî List active sessions<br/>` +
        `<code>/worktrees</code> ‚Äî List git worktrees<br/>` +
        `<code>/health</code> ‚Äî Health check<br/>` +
        `<code>/ask &lt;query&gt;</code> ‚Äî Ask the active agent<br/>` +
        `<code>/help</code> ‚Äî Show this list`;
    }

    // Map commands to their handler functions
    const CMD_MAP = {
      overview:      cmdOverview,
      tasks:         cmdTasks,
      agents:        cmdAgents,
      executor:      cmdExecutor,
      workspaces:    cmdWorkspaces,
      routing:       cmdRouting,
      logs:          cmdLogs,
      integrations:  cmdIntegrations,
      session:       cmdSession,
      ask:           cmdAsk,
      commands:      cmdCommands,
    };

    // ‚îÄ‚îÄ Text input command handling ‚îÄ‚îÄ
    const TEXT_CMD_MAP = {
      '/status':     'overview',
      '/overview':   'overview',
      '/tasks':      'tasks',
      '/agents':     'agents',
      '/executor':   'executor',
      '/workspaces': 'workspaces',
      '/worktrees':  'workspaces',
      '/routing':    'routing',
      '/logs':       'logs',
      '/integrations': 'integrations',
      '/sessions':   'session',
      '/session':    'session',
      '/commands':   'commands',
      '/help':       'commands',
      '/health':     'overview',
    };

    function handleTextInput() {
      const val = inputField.value.trim();
      if (!val) return;

      addUserMessage(val);
      inputField.value = '';

      // Check for slash commands
      const cmdKey = TEXT_CMD_MAP[val.toLowerCase()];
      if (cmdKey && CMD_MAP[cmdKey]) {
        setTimeout(() => addBotMessage(CMD_MAP[cmdKey]()), 300 + Math.random() * 400);
        return;
      }

      // Handle /ask <query> or just freeform text
      if (val.startsWith('/ask ') || !val.startsWith('/')) {
        const query = val.startsWith('/ask ') ? val.slice(5) : val;
        setTimeout(() => {
          addBotMessage(
            `<strong>ü§ñ Agent Response</strong><br/><br/>` +
            `Processing: "<em>${query}</em>"<br/><br/>` +
            `I understand your request. In a live environment, this would be routed to the active agent ` +
            `(<strong>copilot-claude</strong>) for processing.<br/><br/>` +
            `<em>This is a demo ‚Äî agent responses are simulated.</em>`
          );
        }, 500 + Math.random() * 800);
        return;
      }

      // Unknown command
      setTimeout(() => {
        addBotMessage(`‚ö†Ô∏è Unknown command: <code>${val}</code><br/>Type <code>/help</code> to see available commands.`);
      }, 300);
    }

    // ‚îÄ‚îÄ VIEW SWITCHING ‚îÄ‚îÄ

    function openMiniApp() {
      tgView.classList.add('hidden');
      miniView.classList.add('active');

      // Load the real app.js on first open
      if (!miniAppLoaded) {
        miniAppLoaded = true;
        const s = document.createElement('script');
        s.type = 'module';
        s.src = 'app.js';
        document.body.appendChild(s);
      }
    }

    function closeMiniApp() {
      miniView.classList.remove('active');
      tgView.classList.remove('hidden');
      // Scroll chat to bottom
      requestAnimationFrame(() => { msgArea.scrollTop = msgArea.scrollHeight; });
    }

    // ‚îÄ‚îÄ MENU TOGGLE ‚îÄ‚îÄ

    function toggleMenu() {
      menuVisible = !menuVisible;
      stickyMenu.style.display = menuVisible ? '' : 'none';
      menuToggle.textContent = menuVisible ? '‚ò∞' : '‚ò∞';
    }

    // ‚îÄ‚îÄ EVENT LISTENERS ‚îÄ‚îÄ

    // Inline keyboard button clicks
    document.querySelectorAll('.tg-inline-btn[data-cmd]').forEach(btn => {
      btn.addEventListener('click', () => {
        const cmd = btn.dataset.cmd;

        // Open MiniApp
        if (cmd === 'miniapp') {
          addBotMessage('üì± <strong>Opening Control Center...</strong>');
          setTimeout(openMiniApp, 400);
          return;
        }

        // Close menu
        if (cmd === 'close') {
          toggleMenu();
          return;
        }

        // Refresh
        if (cmd === 'refresh') {
          btn.style.background = '#4cc9f0';
          btn.style.color = '#000';
          setTimeout(() => { btn.style.background = ''; btn.style.color = ''; }, 300);
          addBotMessage(cmdOverview());
          return;
        }

        // All other commands ‚Äî produce chat output
        const handler = CMD_MAP[cmd];
        if (handler) {
          // Flash the button
          btn.style.background = '#3a6da0';
          setTimeout(() => { btn.style.background = ''; }, 200);
          // Add response after a short "typing" delay
          setTimeout(() => addBotMessage(handler()), 200 + Math.random() * 300);
        }
      });
    });

    // Back / Close buttons on MiniApp header
    backBtn.addEventListener('click', closeMiniApp);
    closeBtn.addEventListener('click', closeMiniApp);

    // Menu toggle (hamburger in input bar)
    menuToggle.addEventListener('click', toggleMenu);

    // Send button
    sendBtn.addEventListener('click', handleTextInput);

    // Enter key in input
    inputField.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); handleTextInput(); }
    });

    // Fallback: if ES modules fail to load within 12s, show an error
    setTimeout(function() {
      var el = document.getElementById('boot-loader');
      if (el) el.innerHTML = '<div style="text-align:center;padding:40px;font-family:Inter,sans-serif;color:#94a3b8"><div style="font-size:18px;margin-bottom:8px">‚ö†Ô∏è Failed to load</div><div style="font-size:12px;color:#64748b">Check connection (CDN: esm.sh) or refresh</div></div>';
    }, 12000);

    // Expose seed data globally for command handlers
    // (They're already global from the script block in <head>, but just in case)
    window.SEED_TASKS    = window.SEED_TASKS    || [];
    window.SEED_AGENTS   = window.SEED_AGENTS   || [];
    window.SEED_LOGS     = window.SEED_LOGS     || [];
    window.SEED_SESSIONS = window.SEED_SESSIONS || [];
    window.SEED_INFRA    = window.SEED_INFRA    || {};

  })();
  </script>
</body>
</html>
